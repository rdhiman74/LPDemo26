<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>LaunchPath AI — Essay Studio</title>
<style>
    html{font-size:13px;}
    :root{
      --bg0:#020617;
      --bg1:#0b1120;
      --bg2:#16202f;
      --cardA: rgba(255,255,255,.05);
      --cardB: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text:#f3f4f6;
      --muted: rgba(243,244,246,.72);
      --muted2: rgba(243,244,246,.55);
      --accent:#22d3ee;
      --accent2: rgba(34,211,238,.35);
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --r1: 28px;
      --r2: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -120px, rgba(34,211,238,.22), transparent 65%),
        radial-gradient(1000px 600px at 50% 0px, #16202f 0, #0b1120 55%, #020617 100%);
    }
    .wrap{max-width: 1320px; margin: 0 auto; padding: 12px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 2px 16px 2px;
    }
    .brand{font-weight:600; font-size:30px; letter-spacing:-0.02em;}
    .subhead{margin-top:6px; color:var(--muted); font-size:14px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items:start;
      margin-top: 12px;
    }
    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .card:after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--r1);
      pointer-events:none;
      background: linear-gradient(135deg, rgba(34,211,238,.14), transparent 40%, rgba(34,211,238,.10));
      opacity:.8;
      mix-blend-mode: screen;
    }
    .card > *{position:relative}
    .h{font-size:16.5px; font-weight:600; margin:0 0 7px 0;}
    .p{color:var(--muted); margin:0 0 12px 0; line-height:1.55; font-size:12px;}
    .steps{margin-top: 10px; display:grid; gap: 14px;}
    .step{
      display:grid; grid-template-columns: 22px 1fr; gap: 10px;
      align-items:start;
    }
    .num{
      width: 22px; height: 22px; border-radius: 9px;
      border: 1px solid var(--accent2);
      color: var(--accent);
      display:flex; align-items:center; justify-content:center;
      font-weight:600; font-size: 12px;
      margin-top: 2px;
    }
    .step b{display:block; margin-bottom: 3px;}
    .step span{color: var(--muted2); line-height: 1.5;}
    .rightTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .titleBlock{
      display:flex; flex-direction:column; gap:6px;
    }
    .titleBlock .h{margin:0}
    .meta{color:var(--muted2); font-size:12px;}
    .meta b{color: var(--text);}
    .toolbar{
      display:flex; gap: 10px; flex-wrap:nowrap; align-items:center; justify-content:flex-end;
      overflow-x:auto; padding-bottom: 2px;
      scrollbar-width: thin;
    
      position: sticky;
      top: 0;
      z-index: 8;
      background: linear-gradient(180deg, rgba(8,14,26,.92), rgba(8,14,26,.55));
      padding-top: 6px;
    }
    .toolbar::-webkit-scrollbar{height:8px;}
    .toolbar::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:999px;}
    .toolbar::-webkit-scrollbar-track{background: rgba(0,0,0,.12); border-radius:999px;}
    .btn{
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 7px 9px;
      font-weight:600;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,211,238,1), rgba(34,211,238,.35));
      border-color: rgba(34,211,238,.45);
      color: #06101a;
      box-shadow: 0 18px 48px rgba(34,211,238,.16);
    }
    
    .btn.small{padding:10px 14px;font-size:14px;border-radius:14px;line-height:1;}

    .issueBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .issueBtn{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 18px 14px 22px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,22,32,.62);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      
      font-size: 12.5px;
letter-spacing: .2px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      user-select: none;
      overflow: hidden;
    }
    .issueBtn::before{
      content:"";
      position:absolute;
      left:-2px;
      top:-22%;
      width: 14px;
      height: 144%;
      border-radius: 999px;
      background: linear-gradient(to bottom, rgba(var(--accent-rgb),0), rgba(var(--accent-rgb),.95), rgba(var(--accent-rgb),0));
      opacity: .95;
      filter: drop-shadow(0 0 10px rgba(var(--accent-rgb),.35));
      pointer-events:none;
    }
    .issueBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(var(--accent-rgb), .55);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 0 2px rgba(var(--accent-rgb), .18) inset;
    }
    .issueBtn.active{
      border-color: rgba(var(--accent-rgb), .75);
      box-shadow: 0 12px 34px rgba(0,0,0,.38), 0 0 0 2px rgba(var(--accent-rgb), .22) inset;
      background: rgba(12,22,32,.72);
    }
    .issueBtn:active{ transform: translateY(0px) scale(.99); }
    .issueBtn .count{
      font-weight: 900;
      opacity: .95;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(var(--accent-rgb), .45);
      background: rgba(var(--accent-rgb), .12);
    }
    .issueBtn.k-all{ --accent-rgb: 34,211,238; }
    .issueBtn.k-warn{ --accent-rgb: 255,107,107; }
    .issueBtn.k-amber{ --accent-rgb: 255,184,64; }
    .issueBtn.k-minor{ --accent-rgb: 124,124,255; }
    .issueBtn.k-all::before{ opacity:.8; }

    .btn.ghost{
      background: rgba(0,0,0,.15);
    }
    .link{
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 4px;
      cursor:pointer;
      font-weight: 800;
    }
    .tipRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      margin: 14px 0 12px 0;
      color: var(--muted);
      font-size: 12.5px;
    }
    .editor{border-radius:var(--r1); border:1px solid var(--stroke); background:rgba(0,0,0,.18); padding:12px; height:380px; position:relative; overflow:hidden;}
    textarea{
      width:100%;
      height: 100%;
      resize:none;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 12.5px;
      line-height: 1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Ensure draftView (highlighted preview) aligns exactly with textarea */
    #draftView{
      position:absolute;
      inset:12px; /* matches .editor padding */
      overflow:auto;
    }
    #draft{
      position:absolute;
      inset:12px;
      overflow:auto;
    }
    .bottomRow{display:grid; grid-template-columns: 1fr 360px; gap: 10px;
      margin-top: 14px;
    }
    .mini{background:rgba(0,0,0,.15); border:1px solid var(--stroke); border-radius:22px; padding:12px; min-height:110px;}
    .mini h4{margin:0 0 6px 0; font-size: 16px; font-weight:600;}
    .mini p{margin:0; color: var(--muted); line-height: 1.5;}
    .scoreBox{
      display:flex; flex-direction:column; gap: 10px;
    }
    .scoreTop{
      display:flex; align-items:baseline; justify-content:space-between; gap: 10px;
      margin-bottom: 2px;
    }
    .scoreTop .label{
      letter-spacing:.18em; font-weight:600; font-size: 14px; opacity:.9;
    }
    .scoreTop .val{
      font-size: 16px; font-weight:600;
    }
    .pillRow{color: var(--muted); font-size: 14px;}
    .bar{
      height: 12px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,211,238,1), rgba(34,211,238,.35));
    }
    .goal{color: var(--muted); font-size: 14px; line-height: 1.4;}
    .goal b{color: var(--accent);}
    .hidden{display:none !important;}
    .toast{
      position: fixed;
      top: 14px;
      right: 14px;
      background: rgba(20,30,44,.94);
      border: 1px solid rgba(96,220,255,.35);
      color: #e8fbff;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      z-index: 99999;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      font-size: 14px;
      max-width: 360px;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast.error{color: #fca5a5;}
    .toast.ok{color: #86efac;}
    .toast.warn{color: #fde68a;}
    .bottomRow{grid-template-columns: 1fr; }
      .editor{height: 420px;}
    }
  
    .howStrip{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      position:relative;
      overflow:hidden;
      margin-bottom: 14px;
    }
    .howStrip:after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--r1);
      pointer-events:none;
      background: linear-gradient(135deg, rgba(34,211,238,.14), transparent 40%, rgba(34,211,238,.10));
      opacity:.8;
      mix-blend-mode: screen;
    }
    .howStrip > *{position:relative}
    .howTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .howTitle{
      font-weight: 900;
      font-size: 16.5px;
    }
    .howSub{
      color: var(--muted2);
      font-size: 12px;
    }
    .howRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .howStep{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      min-height: 64px;
    }
    .howBadge{
      width: 24px; height: 24px;
      border-radius: 10px;
      border: 1px solid var(--accent2);
      color: var(--accent);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      font-size: 12px;
      flex: 0 0 auto;
      margin-top: 1px;
    }
    .howStep b{
      display:block;
      font-size: 12.5px;
      margin-bottom: 2px;
    }
    .howStep span{
      color: var(--muted2);
      font-size: 11.5px;
      line-height: 1.35;
    }
    @media (max-width: 980px){
      .howRow{grid-template-columns: 1fr;}
    }

    .cols{
      display:grid;
      grid-template-columns: 1.35fr .85fr;
      gap: 14px;
      align-items:start;
    }
    }
    .coachCard .hRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 10px;
    }
    .coachCard .hRow .h{
      font-weight: 900;
      font-size: 16px;
      margin-bottom: 2px;
    }
    .coachCard .hRow .sub{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
    }
    .scorePill{
      border: 1px solid var(--accent2);
      color: var(--text);
      background: rgba(34,211,238,.10);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      min-width: 88px;
      text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .miniBar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      margin: 8px 0 2px;
    }
    .miniBar > div{
      height: 100%;
      width: 0%;
      background: var(--accent);
      border-radius: 999px;
      transition: width .25s ease;
    }
    .coachBlocks{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .coachBlock{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      border-radius: var(--r2);
      padding: 12px;
    }
    .coachBlock .t{
      font-weight: 900;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .coachBlock .body{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.45;
    }


/* --- Layout fix: force two-column editor + coaching panel side-by-side --- */
.grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 18px;
}
.cols{
  display: grid;
  grid-template-columns: minmax(560px, 1.6fr) minmax(360px, 1fr);
  gap: 18px;
  align-items: start;
}
/* keep both columns even on smaller screens; allow horizontal scroll instead of stacking */
html, body{
  min-width: 1024px;
}

/* ===== LP Step 1 Highlights + Issue Map (demo wiring) ===== */
.draftView{
  width:100%;
  height:100%;
  overflow:auto;
  padding:0; /* align exactly with textarea inside .editor */
  border-radius:0;
  border:none;
  background:transparent;
  color:rgba(255,255,255,.92);
  font-size: 12.5px;
  line-height: 1.6;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  white-space:pre-wrap;
}

mark[data-issue]{
  /* sentence-only highlight (no wrap-around artifacts) */
  position:relative;
  display:inline;
  padding:1px 4px;
  margin:0 1px;
  border-radius:10px;
  box-decoration-break:clone;
  -webkit-box-decoration-break:clone;
  white-space:normal;
}

/* Severity colors aligned to pills */
mark[data-issue].sev-warn{
  background:rgba(255,107,107,.18);
  border:1px solid rgba(255,107,107,.30);
  box-shadow:0 0 0 1px rgba(255,107,107,.10);
}
mark[data-issue].sev-amber{
  background:rgba(255,184,64,.16);
  border:1px solid rgba(255,184,64,.28);
  box-shadow:0 0 0 1px rgba(255,184,64,.10);
}
mark[data-issue].sev-minor{
  background:rgba(124,124,255,.14);
  border:1px solid rgba(124,124,255,.24);
  box-shadow:0 0 0 1px rgba(124,124,255,.10);
}

mark[data-issue].w{ background:rgba(250,204,21,.20); border-color:rgba(250,204,21,.32);} /* highlight */
mark[data-issue].c{ background:rgba(250,204,21,.16); border-color:rgba(250,204,21,.22); }
mark[data-issue].p{ background:rgba(52,211,153,.14); border-color:rgba(52,211,153,.20); }
mark[data-issue].r{ background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.20); }

.rewriteTip{
  position:fixed;
  left:0;
  top:0;
  width:300px;
  max-width:calc(100vw - 32px);
  z-index:9999;
  background:#0f172a;
  border:1px solid rgba(255,255,255,.15);
  border-radius:12px;
  padding:10px;
  color:#fff;
  font-size:12px;
  display:none;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
  max-height:240px;
  overflow:auto;
}
.rewriteTip::-webkit-scrollbar{ width:10px; }
.rewriteTip::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.12); border-radius:10px; }

mark[data-issue].tip-open .rewriteTip{ display:block; }
.tipTitle{ font-weight:900; letter-spacing:.06em; text-transform:uppercase; font-size:11px; color:#38bdf8; margin-bottom:6px; }
.tipBody{ line-height:1.35; margin-bottom:8px; color:rgba(255,255,255,.92); }
.copyBtn{
  background:rgba(56,189,248,.14);
  border:1px solid rgba(56,189,248,.40);
  color:#e0f2fe;
  border-radius:999px;
  padding:5px 10px;
  font-size:11px;
  font-weight:850;
  cursor:pointer;
}
.copyBtn:hover{ background:rgba(56,189,248,.22); }

.issueList{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
.issueItem{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:10px;
}
.issueHead{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
.issueTag{ font-size:11px; font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#38bdf8; }
.issueLoc{ font-size:11px; color:rgba(255,255,255,.62); font-weight:750; margin-top:2px; }
.issueWhy{ margin-top:6px; color:rgba(255,255,255,.82); font-size:12px; line-height:1.35; font-weight:650; }
.issueRewrite{
  margin-top:8px;
  border:1px solid rgba(56,189,248,.30);
  background:rgba(56,189,248,.10);
  border-radius:12px;
  padding:8px;
  font-size:12px;
  color:rgba(255,255,255,.92);
  line-height:1.35;
}
.issueActions{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
.miniBtn{
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:rgba(255,255,255,.92);
  font-size:11px;
  font-weight:850;
  padding:5px 10px;
  cursor:pointer;
}
.miniBtn.primary{ border-color:rgba(56,189,248,.45); background:rgba(56,189,248,.14); }
.miniBtn:hover{ background:rgba(255,255,255,.08); }
.miniBtn.primary:hover{ background:rgba(56,189,248,.22); }


/* --- Patch v3: improve highlight readability + smaller hover popover --- */
mark[data-issue]{
  position: relative;
  color: #ffffff !important;
  font-weight: 600;
}
mark[data-issue]::selection{ background: rgba(255,255,255,.18); }
mark[data-issue].hl-yellow,
mark[data-issue].hl-warn{
  background: rgba(245, 208, 66, .28) !important;
  box-shadow: inset 0 -2px 0 rgba(245, 208, 66, .55);
}
mark[data-issue].hl-green,
mark[data-issue].hl-good{
  background: rgba(45, 212, 191, .18) !important;
  box-shadow: inset 0 -2px 0 rgba(45, 212, 191, .35);
}
mark[data-issue].hl-red,
mark[data-issue].hl-risk{
  background: rgba(244, 63, 94, .16) !important;
  box-shadow: inset 0 -2px 0 rgba(244, 63, 94, .32);
}

/* Hover rewrite popover */
mark[data-issue] .rewriteTip{
  width: min(320px, calc(100vw - 24px)) !important;
  max-height: min(260px, calc(100vh - 24px)) !important;
  overflow: auto !important;
  left: 50% !important;
  right: auto !important;
  transform: translateX(-50%) translateY(10px) !important;
  top: 100% !important;
  bottom: auto !important;
}
mark[data-issue]:hover .rewriteTip,
mark[data-issue]:focus-within .rewriteTip{
  display: block !important;
}
.rewriteTip{
  display: none;
  position: absolute;
  z-index: 9999;
  padding: 14px 14px 12px;
  border-radius: 18px;
  background: rgba(9, 18, 32, .96);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
}
.rewriteTip .tipTitle{
  font-size: 12px;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: rgba(34,211,238,.95);
  margin: 0 0 10px 0;
}
.rewriteTip .tipBody{
  font-size: 14px;
  line-height: 1.45;
  color: rgba(255,255,255,.92);
  margin: 0 0 12px 0;
  white-space: normal;
}
.rewriteTip .copyBtn{
  font-size: 13px;
  padding: 9px 12px;
  border-radius: 999px;
}
@media (max-width: 820px){
  mark[data-issue] .rewriteTip{
    left: 12px !important;
    transform: translateY(10px) !important;
  }
}


/* ===== Step 2: Before/After modal ===== */
.baModal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center; justify-content:center;
  padding:18px;
  z-index:9999;
}
.baModal.show{ display:flex; }
.baCard{
  width:min(1000px, 96vw);
  max-height:88vh;
  overflow:auto;
  background:rgba(10,18,34,.96);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
  padding:14px;
}
.baTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.baTitle{font-weight:900;color:rgba(255,255,255,.92);letter-spacing:.06em;text-transform:uppercase;font-size:12px}
.baGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.baLabel{font-size:11px;font-weight:850;color:rgba(255,255,255,.70);margin:2px 0 6px}
.baBox{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:10px;
  color:rgba(255,255,255,.90);
  white-space:pre-wrap;
  line-height:1.5;
  font-size:13px;
}
.baActions{display:flex;justify-content:flex-end;margin-top:10px}
@media (max-width:820px){ .baGrid{grid-template-columns:1fr} }


.pulse{ outline:2px solid rgba(0, 210, 255, .8); box-shadow:0 0 0 6px rgba(0,210,255,.15); border-radius:6px; }


/* Issue Map rendering (Phase 1B) */
.issueItem{border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:12px 12px; background:rgba(255,255,255,.03); cursor:pointer;}
.issueItem:hover{border-color: rgba(0,224,255,.35); background:rgba(0,224,255,.06);}
.pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800; letter-spacing:.02em; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05);}
.pillR{border-color: rgba(255,84,84,.35); color:#ffb3b3; background:rgba(255,84,84,.10);}
.pillA{border-color: rgba(255,199,0,.35); color:#ffe1a1; background:rgba(255,199,0,.10);}
.pillW{border-color: rgba(138,214,255,.35); color:#bfeaff; background:rgba(138,214,255,.10);}
.ghost.active{outline: 1px solid rgba(0,224,255,.45); background: rgba(0,224,255,.10);}
mark.flash{animation: lpFlash .8s ease-in-out;}
@keyframes lpFlash{0%{box-shadow:0 0 0 0 rgba(0,224,255,.0);} 35%{box-shadow:0 0 0 6px rgba(0,224,255,.25);} 100%{box-shadow:0 0 0 0 rgba(0,224,255,.0);}}

/* ===== Coach Engine v1 (offline demo) ===== */
.coachItem{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:10px;
}
.coachItem .k{font-weight:900;letter-spacing:.08em;text-transform:uppercase;font-size:11px;color:rgba(34,211,238,.95)}
.coachItem .t{font-weight:850;margin-top:4px}
.coachItem .d{color:rgba(255,255,255,.72);font-size:12px;line-height:1.45;margin-top:6px}
.suggCard{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.14);
  border-radius:14px;
  padding:10px;
}
.suggCard .meta{color:rgba(255,255,255,.62);font-size:11.5px;margin-bottom:6px}
.suggCard .before{color:rgba(255,255,255,.86);font-size:12.5px;line-height:1.45}
.suggCard .after{margin-top:8px;border:1px solid rgba(34,211,238,.28);background:rgba(34,211,238,.10);border-radius:12px;padding:8px;color:rgba(255,255,255,.92);font-size:12.5px;line-height:1.45}
.suggCard .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}


/* ===== Coach Tabs (no-scroll UX) ===== */
.coachTabs{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;           /* keep in ONE line */
  overflow:hidden;
  padding:10px 0 10px 0;
}
.coachTab{
  white-space:nowrap;         /* prevent wrapping in button */
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.88);
  border-radius:999px;
  padding:7px 10px;           /* smaller so 5 fit */
  font-weight:800;
  font-size:11px;             /* smaller so 5 fit */
  letter-spacing:0;
  cursor:pointer;
}
.coachTab.active{
  border-color: rgba(34,211,238,.55);
  background: rgba(34,211,238,.16);
}


/* ===== Coach Issue Pills: pill look + colored accents ===== */
.issuePills .pill{ position:relative; }
.issuePills .pill::before{
  content:"";
  position:absolute;
  left:-1px; top:-1px;
  width:10px; height:calc(100% + 2px);
  border-radius:999px;
  opacity:.9;
  background: rgba(34,211,238,.55);
}
.issuePills .pill[data-filter="warn"]::before{ background: rgba(255,107,107,.65); }
.issuePills .pill[data-filter="amber"]::before{ background: rgba(255,184,64,.70); }
.issuePills .pill[data-filter="minor"]::before{ background: rgba(124,124,255,.70); }
.issuePills .pill span{ font-weight:900; }
/* ===== Issue Pills (show after Step 1) ===== */
.issuePills{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;
  overflow:hidden;
  padding:0 0 12px 0;
}
.issuePills.hidden{ display:none; }
.issuePills .pill{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  color:rgba(255,255,255,.88);
  border-radius:999px;
  padding:7px 10px;
  font-weight:800;
  font-size:11px;
  white-space:nowrap;
  cursor:pointer;
}
.issuePills .pill.active{
  border-color: rgba(34,211,238,.55);
  background: rgba(34,211,238,.14);
}





/* ===== Issue Map Filter Pills: compact pill style, aligned higher ===== */
.issueControls{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:-6px;            /* move UP closer to title */
}
.issueBtns{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;
}
.issueBtn{
  background:rgba(255,255,255,.06) !important;
  border:1px solid rgba(255,255,255,.18) !important;
  padding:5px 10px !important;
  border-radius:999px !important;
  font-size:11px !important;
  font-weight:800 !important;
  letter-spacing:0 !important;
  color:rgba(255,255,255,.9) !important;
  text-decoration:none !important;
  box-shadow:none !important;
}
.issueBtn:hover{
  border-color: rgba(34,211,238,.45) !important;
  color: rgba(34,211,238,.95) !important;
}
.issueBtn.active{
  background: rgba(34,211,238,.18) !important;
  border-color: rgba(34,211,238,.6) !important;
  color: rgba(34,211,238,.98) !important;
}
.issueHint{
  font-size:11px !important;
  color: rgba(255,255,255,.60) !important;
}


/* ===== Issue Map Filter Pills: restore pill look + position ===== */
.issueList .muted{ color: rgba(255,255,255,.62); }
.issueList > div:first-child{ margin-top:-6px; } /* lift the controls a bit */
.issueList .issueBtn{
  background:rgba(255,255,255,.06) !important;
  border:1px solid rgba(255,255,255,.18) !important;
  padding:5px 10px !important;
  border-radius:999px !important;
  font-size:11px !important;
  font-weight:800 !important;
  letter-spacing:0 !important;
  color:rgba(255,255,255,.9) !important;
  text-decoration:none !important;
  box-shadow:none !important;
}
.issueList .issueBtn:hover{
  border-color: rgba(34,211,238,.45) !important;
  color: rgba(34,211,238,.95) !important;
}
.issueList .issueBtn.active{
  background: rgba(34,211,238,.18) !important;
  border-color: rgba(34,211,238,.6) !important;
  color: rgba(34,211,238,.98) !important;
}


/* ===== Step 2 Diff Highlight ===== */
.diffAdd{
  background: rgba(34,211,238,.18);
  border: 1px solid rgba(34,211,238,.35);
  border-radius: 10px;
  padding: 2px 6px;
}


/* ===== Step 2 popup: preserve paragraph spacing ===== */
#baBefore, #baAfter{ white-space: pre-wrap; }


/* ===== Step 2 popup: show paragraph breaks ===== */
#baBefore, #baAfter{ white-space: pre-wrap; }


/* ===== Severity override (ensures Warning shows red even if other classes exist) ===== */
mark[data-issue].sev-warn{ background:rgba(255,107,107,.18) !important; border:1px solid rgba(255,107,107,.30) !important; }
mark[data-issue].sev-amber{ background:rgba(255,184,64,.16) !important; border:1px solid rgba(255,184,64,.28) !important; }
mark[data-issue].sev-minor{ background:rgba(124,124,255,.14) !important; border:1px solid rgba(124,124,255,.24) !important; }


    /* Replace button success state */
    .btnReplace.replaced{
      border-color: rgba(120,255,220,.55) !important;
      box-shadow: 0 0 0 2px rgba(120,255,220,.12) inset;
      background: rgba(20,40,36,.55) !important;
      color: #e9fff7 !important;
    }
    .btnReplace .chk{
      display:inline-block;
      margin-left:8px;
      font-weight:800;
      color: #7dffd4;
    }
    

    .baSummary{
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(96,220,255,.18);
      background: rgba(12,18,28,.55);
      border-radius: 14px;
      font-size: 13px;
      color: rgba(232,251,255,.92);
      line-height: 1.35;
    }
    .baSummary b{ color: #e8fbff; }
    .baSummary .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .baSummary .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(96,220,255,.18);
      background: rgba(20,30,44,.55);
      font-weight: 650;
    }
    .baText{
      white-space: pre-wrap;
    }


/* Submission Ready pill (appears only when criteria pass) */
.submissionReady{
  display:inline-flex;
  align-items:center;
  margin-left:12px;
  padding:8px 14px;
  border-radius:999px;
  font-weight:800;
  font-size:13px;
  letter-spacing:.2px;
  border:1px solid rgba(120,255,220,.55);
  background: rgba(16,40,34,.55);
  color: rgba(235,255,248,.98);
  box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset;
}
.submissionReady.hidden{ display:none !important; }


/* Inline sample essays panel */
.samplesPanel{ margin: 12px 0 14px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); border-radius: 16px; padding: 12px; }
.samplesPanel.hidden{ display:none !important; }
.samplesPanelHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.08); }
.samplesPanelTitle{ font-weight: 850; letter-spacing:.2px; }
.samplesPanelActions{ display:flex; gap:10px; }
.samplesPanelBody{ display:grid; grid-template-columns: 320px 1fr; gap: 12px; padding-top: 12px; }
.samplesTiles{ display:grid; grid-template-columns: 1fr; gap: 10px; max-height: 320px; overflow:auto; padding-right: 6px; }
.sampleTile{ border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius: 14px; padding: 10px 10px; cursor:pointer; }
.sampleTile:hover{ background: rgba(255,255,255,.07); }
.sampleTile.active{ border-color: rgba(120,255,220,.45); background: rgba(16,40,34,.45); }
.sampleTileTitle{ font-weight: 800; margin-bottom: 3px; }
.sampleTileSub{ font-size: 12px; opacity:.82; line-height:1.35; }
.samplesPreview{ border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); border-radius: 14px; padding: 10px; overflow:hidden; display:flex; flex-direction:column; }
.samplesPreviewTitle{ font-weight: 850; margin-bottom: 2px; }
.samplesPreviewMeta{ font-size: 12px; opacity:.80; margin-bottom: 10px; }
.samplesPreviewText{ overflow:auto; white-space: pre-wrap; line-height: 1.5; padding-right: 6px; }
@media (max-width: 860px){
  .samplesPanelBody{ grid-template-columns: 1fr; }
  .samplesTiles{ max-height: 200px; }
}

</style>

<style>
/* Injected to match College Match header exactly */
LaunchPath unified header (scoped) ===== */
.lp-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:22px;
}
.lp-header-right{
  display:flex;
  align-items:center;
  gap:12px;
}
.brand-lockup{display:flex;align-items:center;gap:12px;}
.brand-mark{
  width:40px;height:40px;border-radius:999px;
  background:radial-gradient(circle at 30% 0,#22d3ee 0,#0ea5e9 40%,#111827 95%);
  box-shadow:0 0 0 2px rgba(56,189,248,.6),0 14px 30px rgba(15,23,42,.9);
}
.brand-text-main{
  font-size:1.05rem;
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:700;
}
.brand-text-sub{
  font-size:.86rem;
  color:#cbd5f5;
}
.lp-nav{display:flex;align-items:center;gap:12px;}
.lp-nav-link{
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(56,189,248,.45);
  background:rgba(15,23,42,.55);
  color:rgba(224,242,254,.86);
  text-decoration:none;
  font-size:.86rem;
  line-height:1.1;
  white-space:nowrap;
}
.lp-nav-link:hover{border-color:rgba(56,189,248,.75);background:rgba(15,23,42,.75);}
.lp-actions{display:flex;align-items:center;gap:10px;}
.lp-action{
  padding:10px 16px;
  border-radius:999px;
  text-decoration:none;
  font-size:.86rem;
  white-space:nowrap;
  border:1px solid rgba(56,189,248,.75);
  background:rgba(15,23,42,.65);
  color:rgba(224,242,254,.92);
}
.lp-action.lp-school{
  border-color:rgba(168,85,247,.75);
}
.lp-action:hover{filter:brightness(1.05);}
@media(max-width:840px){
  .lp-header{flex-direction:column;align-items:flex-start;}
  .lp-header-right{width:100%;justify-content:space-between;}
}

/* ===== LaunchPath unified header (2 buttons) ===== */
.lp-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:22px;
}
.lp-header-right{display:flex;align-items:center;gap:12px;margin-left:auto;justify-content:flex-end;}
.brand-lockup{display:flex;align-items:center;gap:12px;}
.brand-mark{
  width:40px;height:40px;border-radius:999px;
  background:radial-gradient(circle at 30% 0,#22d3ee 0,#0ea5e9 40%,#111827 95%);
  box-shadow:0 0 0 2px rgba(56,189,248,.6),0 14px 30px rgba(15,23,42,.9);
}
.brand-text-main{
  font-size:1.05rem;
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:700;
}
.brand-text-sub{font-size:.86rem;color:#cbd5f5;}
.lp-nav{display:flex;align-items:center;gap:12px;margin-left:auto;justify-content:flex-end;}
.lp-nav-link{
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(56,189,248,.45);
  background:rgba(15,23,42,.55);
  color:rgba(224,242,254,.86);
  text-decoration:none;
  font-size:.86rem;
  line-height:1.1;
  white-space:nowrap;
}
.lp-nav-link:hover{border-color:rgba(56,189,248,.75);background:rgba(15,23,42,.75);}
.lp-actions{display:flex;align-items:center;gap:10px;}
.lp-action{
  padding:10px 16px;
  border-radius:999px;
  text-decoration:none;
  font-size:.86rem;
  white-space:nowrap;
  border:1px solid rgba(56,189,248,.75);
  background:rgba(15,23,42,.65);
  color:rgba(224,242,254,.92);
}
.lp-action.lp-school{border-color:rgba(168,85,247,.75);}
@media(max-width:840px){
  .lp-header{flex-direction:column;align-items:flex-start;}
  .lp-header-right{width:100%;justify-content:space-between;}
}
/* ===== End header ===== */


/* Patch: keep Issue Map filter buttons on ONE line (scroll if needed) */
#issueList > div:first-child{
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
}
#issueList > div:first-child::-webkit-scrollbar{height:8px;}
#issueList > div:first-child::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:999px;}
#issueList > div:first-child::-webkit-scrollbar-track{background: rgba(0,0,0,.12); border-radius:999px;}

</style>
</head>
<body>
<div class="wrap">
<header class="lp-header">
  <div class="brand-lockup">
    <div class="brand-mark"></div>
    <div class="brand-text">
      <div class="brand-text-main">LAUNCHPATH AI</div>
      <div class="brand-text-sub">College Match · Essays · ROI · Social Studio</div>
    </div>
  </div>
  <nav class="lp-nav">
    <a class="lp-nav-link" href="index.html">Home</a>
    <a class="lp-nav-link" href="student-workplace.html">Student Workplace</a>
  </nav>
</header>
<div class="grid">
<!-- LEFT: How it works -->
<div aria-label="How Essay Studio works (horizontal)" class="howStrip">
<div class="howTop">
<div>
<div class="howTitle">How Essay Studio works</div>
<div class="howSub">A simple 3-step workflow students can finish in minutes.</div>
</div>
</div>
<div class="howRow">
<div class="howStep">
<div class="howBadge">1</div>
<div>
<b>Strategy Review</b>
<span>Coaching on structure, story, voice, and clarity + prioritized fixes.</span>
</div>
</div>
<div class="howStep">
<div class="howBadge">2</div>
<div>
<b>Highlighted Corrections</b>
<span>Up to 20 key improvements highlighted directly in the draft.</span>
</div>
</div>
<div class="howStep">
<div class="howBadge">3</div>
<div>
<b>Final Polish</b>
<span>Submission-ready cleanup while preserving student voice.</span>
</div>
</div>
</div>
</div>
<div class="cols">
<section aria-label="Essay Studio editor" class="card">
<div class="rightTop">
<div class="titleBlock">
<div class="h">Essay Studio</div>
<div class="meta">Write, review, and polish your college essay draft with AI support.</div>
</div>
<div class="meta" id="wordMeta">Words: <b id="wordCount">0</b> / 650</div>
<div class="toolbar">
<button class="btn primary" id="btnStep1" title="Step 1: Coaching + Outline + Smart Review">Step 1: Strategy Review</button>
<button class="btn ghost" id="btnStep2" title="Step 2: Final Polish draft (after Step 1)">Step 2: Final Polish</button>
<button class="btn ghost" id="btnBeforeAfter" title="Toggle before/after view">Before / After</button>
<button class="btn ghost" id="btnSave" title="Save this draft to your list">Save to My List</button> <span id="submissionReadyPill" class="submissionReady hidden">✓ Submission Ready</span>
</div>
</div>
<div class="tipRow">
<div><b>Draft</b>   <span class="link" id="viewSamples">View 5 sample essays</span></div>
<div>Tip: Use samples for ideas, then rewrite in your own words and voice.</div>
</div>

<!-- Sample Essays (Inline Panel) -->
<div id="samplesPanel" class="samplesPanel hidden" aria-label="Sample essays panel">
  <div class="samplesPanelHeader">
    <div class="samplesPanelTitle">Sample Essays (for inspiration)</div>
    <div class="samplesPanelActions">
      <button id="samplesCopyBtn" class="btn ghost" type="button">Copy</button>
      <button id="samplesCloseBtn" class="btn ghost" type="button">Close</button>
    </div>
  </div>
  <div class="samplesPanelBody">
    <div class="samplesTiles" id="samplesTiles"></div>
    <div class="samplesPreview">
      <div class="samplesPreviewTitle" id="samplesPreviewTitle">Select a sample</div>
      <div class="samplesPreviewMeta" id="samplesPreviewMeta">Click a tile to view the full sample.</div>
      <div class="samplesPreviewText" id="samplesPreviewText"></div>
    </div>
  </div>
</div>

<div class="editor">
<textarea id="draft" placeholder="Start writing here, or paste a paragraph you want LaunchPath AI to review..."></textarea>
<div id="draftView" class="draftView hidden" aria-label="Highlighted Draft Preview"></div>
</div>
<div class="bottomRow">
<div class="pillRow">Structure · Story · Voice · Polish</div>
<div aria-label="Draft strength bar" class="bar"><div id="barFill"></div></div>
<div class="goal">Goal: <b>80+</b> before submit · Admissions lens</div>
</div>
</section><section aria-label="LP Coaching Panel" class="card coachCard">
<div class="hRow">
<div>
<div class="h">LP Coaching Panel</div>
<div class="sub">Target readiness: <b>80+</b>. Run <b>Step 1</b> to generate coaching + highlights.</div>
</div>
<div class="scorePill"><span id="scoreVal">—</span>/100</div>
</div>
<div aria-label="Readiness score bar" class="miniBar">
<div id="coachBarFill"></div>
</div>
<div style="display:flex; justify-content:space-between; color: var(--muted2); font-size: 11.5px;">
<span>0</span><span>Target: 80</span><span>100</span>
</div>

<div class="coachTabs" id="coachTabs">
  <button class="coachTab active" data-tab="overview" type="button">Overview</button>
  <button class="coachTab" data-tab="issues" type="button">Issues</button>
  <button class="coachTab" data-tab="sentences" type="button">Sentences</button>
  <button class="coachTab" data-tab="outline" type="button">Outline</button>
  <button class="coachTab" data-tab="questions" type="button">Questions</button>
</div>

<div class="issuePills hidden" id="issuePills" aria-label="Issue severity filters">
  <button class="pill active" data-filter="all" type="button">All (<span id="pillAll">0</span>)</button>
  <button class="pill" data-filter="warn" type="button">Warnings (<span id="pillWarn">0</span>)</button>
  <button class="pill" data-filter="amber" type="button">Amber (<span id="pillAmber">0</span>)</button>
  <button class="pill" data-filter="minor" type="button">Minor (<span id="pillMinor">0</span>)</button>
</div>


<div class="coachBlocks">


<div aria-label="Coach Scorecard" class="coachBlock" id="coachScorecardBlock" data-tab="overview">
  <div class="t">Coach Scorecard</div>
  <div class="body">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
      <div>
        <div style="font-weight:900;margin-bottom:4px">Structure</div>
        <div class="miniBar"><div id="scStructure"></div></div>
        <div style="color:rgba(255,255,255,.62);font-size:11.5px"><span id="scStructureVal">—</span>/25</div>
      </div>
      <div>
        <div style="font-weight:900;margin-bottom:4px">Clarity</div>
        <div class="miniBar"><div id="scClarity"></div></div>
        <div style="color:rgba(255,255,255,.62);font-size:11.5px"><span id="scClarityVal">—</span>/25</div>
      </div>
      <div>
        <div style="font-weight:900;margin-bottom:4px">Voice</div>
        <div class="miniBar"><div id="scVoice"></div></div>
        <div style="color:rgba(255,255,255,.62);font-size:11.5px"><span id="scVoiceVal">—</span>/25</div>
      </div>
      <div>
        <div style="font-weight:900;margin-bottom:4px">Specificity</div>
        <div class="miniBar"><div id="scSpecificity"></div></div>
        <div style="color:rgba(255,255,255,.62);font-size:11.5px"><span id="scSpecificityVal">—</span>/25</div>
      </div>
    </div>
    <div style="margin-top:10px;color:rgba(255,255,255,.72);font-size:12px" id="coachOneLine">
      Run <b>Step 1</b> to generate your score + top fixes.
    </div>
  </div>
</div>

<div aria-label="Coach Action Plan" class="coachBlock" id="coachPlanBlock" data-tab="overview">
  <div class="t">Action Plan (do these next)</div>
  <div class="body">
    <div id="coachPlan" style="display:grid;gap:8px;margin-top:6px">
      <div style="color:rgba(255,255,255,.62)">Run <b>Step 1</b> to see a prioritized plan.</div>
    </div>
  </div>
</div>

<div aria-label="Coach Questions" class="coachBlock" id="coachQuestionsBlock" data-tab="questions">
  <div class="t">Coach Questions</div>
  <div class="body">
    <div id="coachQuestions" style="display:grid;gap:8px;margin-top:6px">
      <div style="color:rgba(255,255,255,.62)">Run <b>Step 1</b> to generate coaching questions.</div>
    </div>
  </div>
</div>

<div aria-label="Sentence Suggestions" class="coachBlock" id="coachSentenceBlock" data-tab="sentences">
  <div class="t">Sentence Suggestions (optional)</div>
  <div class="body">
    <div style="color:rgba(255,255,255,.62);font-size:12px;margin-bottom:8px">
      Suggestions are <b>sentence-level</b> to preserve student voice (no full essay writing).
    </div>
    <div id="coachSentenceList" style="display:grid;gap:10px">
  <div style="color:rgba(255,255,255,.70);font-size:12.5px;line-height:1.5">
    Click an <b>Amber</b> or <b>Warning</b> item in the <b>Issues</b> tab to open a focused suggestion.
  </div>
</div>
    </div>
  </div>
</div>

<div aria-label="Outline Builder" class="coachBlock" id="coachOutlineBlock" data-tab="outline">
  <div class="t">Outline Builder</div>
  <div class="body">
    <div id="coachOutline" style="display:grid;gap:8px;margin-top:6px">
      <div style="color:rgba(255,255,255,.62)">Run <b>Step 1</b> to generate a suggested outline.</div>
    </div>
  </div>
</div>

<div aria-label="LP Issue Map" class="coachBlock" data-tab="issues">
  <div class="t">LP Issue Map (Top Fixes)</div>
  <div class="body">
    <div id="issueList" class="issueList"></div>
  </div>
</div>

<div aria-label="Final Polish Preview" class="coachBlock" id="polishBlock" style="display:none">
  <div class="t">Final Polish (Step 2)</div>
  <div class="body">
    <div id="polishPreview" style="white-space:pre-wrap;line-height:1.5;color:rgba(255,255,255,.92)"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="miniBtn primary" id="copyPolished" type="button">Copy Final</button>
      <button class="miniBtn" id="openBeforeAfter2" type="button">Before / After</button>
    </div>
  </div>
</div>

<div aria-label="Highlights note" class="coachBlock">
<div class="t">Highlighted corrections</div>
<div class="body">Up to <b>20</b> key improvements will be highlighted directly in the draft after Step 1.</div>
</div>
</div>
</section></div>
<div class="toast" id="toast"></div>


</div></div>





<script>
/* ===== LP Step 1: highlight up to 20 + map to right pane (demo) ===== */
(function(){
  const MAX = 20;
  const FILLERS = ["very","really","just","kind of","sort of","basically","literally","actually","maybe","a lot"];
  const VAGUE = ["good","bad","nice","great","amazing","awesome","interesting","important","thing","things","stuff"];
  const PASSIVE = /\b(was|were|is|are|been|being)\b\s+\b\w+(ed|en)\b/i;
  const WEAK_START = /^(there is|there are|i think|i feel|in conclusion|overall)\b/i;

  const $ = (id)=>document.getElementById(id);

  // Simple toast helper (keeps UI clean after re-render)
  function lpToast(msg, kind="ok", ms=3000){
    const el = $("toast");
    if(!el) return;
    el.textContent = msg || "";
    el.classList.add("show");
    if(lpToast._t) clearTimeout(lpToast._t);
    lpToast._t = setTimeout(()=>{
      el.classList.remove("show");
      el.textContent = "";
    }, ms);
  }

  // Dedupe issues so pill filters don't show repeated identical items (demo-friendly)
  function lpDedupeIssues(items){
    const arr = Array.isArray(items) ? items : [];
    const map = new Map();
    arr.forEach(it=>{
      const sent = String(it?.sentence||"").trim().replace(/\s+/g," ").toLowerCase();
      const key = `${it?.type||""}|${it?.cls||""}|${it?.sev||0}|${sent}`;
      if(!map.has(key)){
        const copy = Object.assign({}, it);
        copy._dupCount = 1;
        copy._dupSidx = [it?.sidx];
        map.set(key, copy);
      } else {
        const cur = map.get(key);
        cur._dupCount = (cur._dupCount||1) + 1;
        cur._dupSidx = cur._dupSidx || [];
        cur._dupSidx.push(it?.sidx);
      }
    });
    return Array.from(map.values());
  }

  function sentenceSplit(text){
    return text.replace(/\s+/g,' ')
      .split(/(?<=[\.\!\?])\s+(?=[A-Z0-9“"'])/)
      .map(s=>s.trim())
      .filter(Boolean);
  }
  function esc(s){
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function score(sentence, idx){
    const issues = [];
    const lower = sentence.toLowerCase();
    const wc = sentence.split(/\s+/).filter(Boolean).length;

    if(wc >= 28) issues.push({type:"Clarity", cls:"c", sev:3, why:"This sentence is long. Split it into two and lead with the key point."});
    if(PASSIVE.test(sentence)) issues.push({type:"Voice", cls:"p", sev:2, why:"Passive voice reduces impact. Rewrite in active voice (who did what?)."});
    if(WEAK_START.test(lower)) issues.push({type:"Hook", cls:"r", sev:3, why:"Weak opener. Start with a specific moment or action to hook the reader."});

    const fillerHits = FILLERS.filter(w=>lower.includes(w));
    if(fillerHits.length) issues.push({type:"Wording", cls:"w", sev:1, why:`Remove filler (${fillerHits.slice(0,3).join(", ")}). Be more direct.`});

    const vagueHits = VAGUE.filter(w=>new RegExp(`\\b${w}\\b`,'i').test(sentence));
    if(vagueHits.length) issues.push({type:"Specificity", cls:"w", sev:2, why:`Replace vague words (${vagueHits.slice(0,3).join(", ")}). Add details, numbers, or outcomes.`});

    if(/\b(i learned|i realized|i understood)\b/i.test(sentence) && wc < 22){
      issues.push({type:"Depth", cls:"p", sev:2, why:"Insight is stated but not proven. Add a short example or what changed in your behavior."});
    }

    issues.forEach(it=>{
      it.sidx = idx;
      it.sentence = sentence;
    });
    return issues;
  }

  
  function lpReplaceSentenceAtIndex(sidx, newSentence){
    const ta = document.getElementById("essayText") || document.getElementById("draft");
    if(!ta) return;
    const text = (ta.value||"").trim();
    const parts = sentenceSplit(text);
    if(!parts.length || !Number.isFinite(sidx) || sidx<0 || sidx>=parts.length){
      return;
    }
    parts[sidx] = newSentence;
    ta.value = parts.join(" ");
    // re-run step 1 (highlights + coaching)
    if(typeof runStep1 === "function"){
      runStep1();
      // try to jump to the updated highlight
      setTimeout(()=>{
        const mark = document.querySelector(`mark[data-sidx="${sidx}"]`);
        if(mark){ mark.scrollIntoView({behavior:"smooth", block:"center"}); mark.classList.add("pulse"); setTimeout(()=>mark.classList.remove("pulse"),900); }
      }, 80);
    }
  }

function generateRewrite(sentence, type){
    const s = sentence.trim().replace(/\s+/g,' ');
    if(type==="Clarity"){
      const parts = s.split(/,\s+| and /);
      if(parts.length>=2){
        let tail = parts.slice(1).join(" ").trim();
        tail = tail.replace(/^and\s+/i,"");
        if(tail.length) tail = tail[0].toUpperCase() + tail.slice(1);
        return parts[0].trim()+". "+tail;
      }
      return "Rewrite shorter: Start with the main action, then add one supporting detail.";
    }

    if(type==="Hook"){
      return "Start with a specific moment: “In [place/time], I [did action], and it changed how I [think/act].”";
    }
    if(type==="Voice"){
      return s.replace(/\bwas\b|\bwere\b|\bbeen\b|\bbeing\b/gi,"")
              .replace(/\s{2,}/g,' ')
              .trim();
    }
    if(type==="Specificity"){
      return s.replace(/\b(good|great|nice|amazing|awesome|interesting|important)\b/gi,"meaningful")
              .replace(/\bthings\b|\bstuff\b/gi,"specific outcomes")
              .trim();
    }
    if(type==="Depth"){
      return s + " For example, I [specific action] and the result was [measurable outcome].";
    }
    // Wording
    return s.replace(/\bvery\b|\breally\b|\bjust\b|\bkind of\b|\bsort of\b|\bbasically\b|\bliterally\b|\bactually\b/gi,"")
            .replace(/\s{2,}/g,' ')
            .trim();
  }// Replace a single highlighted sentence in-place and keep the editable textarea in sync.
function lpReplaceSentence(sidx, newSentence){
  const idx = Number(sidx);
  if(!Number.isFinite(idx)) return;

  window.lpEssayState = window.lpEssayState || {};
  // Baseline snapshot for Before/After (original essay before Step 1)
  const __state = window.lpEssayState;
  if(typeof __state.baselineBefore === "undefined") __state.baselineBefore = null;
  if(typeof __state.afterPolish === "undefined") __state.afterPolish = "";
  const state = window.lpEssayState;

  state.replacements = state.replacements || {};
  state.replacements[idx] = String(newSentence || "").trim();

  // Update the marked highlight in the rendered view (if present)
  const mark = document.querySelector(`mark[data-sidx="${idx}"]`);
  if(mark){
    const cls = mark.getAttribute("data-issue") || "";
    mark.innerHTML = `${esc(state.replacements[idx])}<span class="rewriteTip"><div class="tipTitle">Replaced</div><div class="tipBody">${esc(state.replacements[idx])}</div></span>`;
    mark.setAttribute("data-issue", cls);
  }

  // Update the editable textarea draft value using the last known sentence split
  if(Array.isArray(state.sents) && state.sents.length){
    const merged = state.sents.map((s,i)=> (state.replacements[i] ? state.replacements[i] : s)).join(" ");
    $("draft").value = merged;
  }
  // Re-run analysis so highlights, counts, and score update immediately
}

  function renderIssueList(items){
  const root = $("issueList");
  root.innerHTML = "";

  const list = document.createElement("div");
  list.className = "issueList";
  root.appendChild(list);

  const arr = Array.isArray(items) ? items : [];
  const deduped = lpDedupeIssues(arr);
  if(!deduped.length){
    const msg = document.createElement("div");
    msg.className = "muted";
    msg.style.padding = "8px 0";
    msg.textContent = "No items in this filter.";
    list.appendChild(msg);
    return;
  }

  // sort: highest severity first, then by sentence position
  const sorted = arr.slice().sort((a,b)=>{
    if((b.sev||0)!==(a.sev||0)) return (b.sev||0)-(a.sev||0);
    return (a.sidx||0)-(b.sidx||0);
  });

  sorted.forEach((it)=>{
    const card = document.createElement("div");
    card.className = "issueItem";
    card.dataset.sidx = String(it.sidx ?? -1);
    card.tabIndex = 0;

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.gap = "10px";
    top.style.alignItems = "center";
    top.style.justifyContent = "space-between";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.flexDirection = "column";

    const sevPill = document.createElement("span");
    const sev = it.sev || 0;
    sevPill.className = "pill " + (sev>=3 ? "pillR" : (sev===2 ? "pillA" : "pillW"));
    sevPill.textContent = sev>=3 ? "Warning" : (sev===2 ? "Amber" : "Minor");

    const title = document.createElement("div");
    title.style.fontWeight = "900";
    title.style.fontSize = "13px";
    title.style.marginTop = "6px";
    title.textContent = (it.type || "Issue") + (Number.isFinite(it.sidx) ? ` • Sentence ${Number(it.sidx)+1}` : "") + ((it._dupCount||1)>1 ? ` • ${it._dupCount} similar` : "");

    left.appendChild(sevPill);
    left.appendChild(title);

    const actions = document.createElement("div");
    actions.style.display = "flex";
    actions.style.gap = "8px";
    actions.style.alignItems = "center";

    const btnReplace = document.createElement("button");
    btnReplace.type = "button";
    btnReplace.className="btn small";
    btnReplace.textContent = "Replace sentence";
    btnReplace.dataset.action = "replace";
    btnReplace.dataset.sidx = String(it.sidx ?? -1);
    btnReplace.dataset.rewrite = it.rewrite || "";
    actions.appendChild(btnReplace);

    top.appendChild(left);
    top.appendChild(actions);

    const why = document.createElement("div");
    why.className = "muted";
    why.style.marginTop = "6px";
    why.textContent = it.why || "";

    const excerpt = document.createElement("div");
    excerpt.style.marginTop = "8px";
    excerpt.style.fontSize = "13px";
    excerpt.style.color = "rgba(255,255,255,.88)";
    excerpt.style.lineHeight = "1.45";
    excerpt.textContent = (it.rewrite && it.rewrite.trim()) ? it.rewrite : (it.sentence || "");

    card.appendChild(top);
    card.appendChild(why);
    card.appendChild(excerpt);

    const jump = ()=>{
      const mark = document.querySelector(`mark[data-sidx="${it.sidx}"]`);
      if(mark){
        mark.scrollIntoView({behavior:"smooth", block:"center"});
        mark.classList.add("flash");
        setTimeout(()=>mark.classList.remove("flash"), 800);
      }
    };

    card.addEventListener("click",(e)=>{
      if(e.target && e.target.dataset && e.target.dataset.action==="replace") return;
      jump();
    });
    card.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        jump();
      }
    });

    btnReplace.addEventListener("click",(e)=>{
      e.preventDefault();
      e.stopPropagation();
      const sidx = parseInt(btnReplace.dataset.sidx,10);
      const rw = btnReplace.dataset.rewrite || "";
      if(!Number.isFinite(sidx) || !rw) return;
      btnReplace.textContent = "Replaced ✓";
      btnReplace.disabled = true;
      // Remove the issue card immediately for a clean demo feel
      card.style.transition = "opacity 160ms ease";
      card.style.opacity = "0";
      setTimeout(()=>{ try{ card.remove(); }catch(e){} }, 180);
      // Apply replacement + re-run analysis after UI feedback
      window.lpEssayState = window.lpEssayState || {};
      const state = window.lpEssayState;
      state.replacements = state.replacements || {};
      state.replacements[sidx] = rw;
      if(typeof lpReplaceSentenceAtIndex === "function") lpReplaceSentenceAtIndex(sidx, rw);
      setTimeout(()=>{ if(typeof runStep1 === "function") runStep1(); }, 200);
    });

    list.appendChild(card);
  });

  // expose for pill filtering re-render
  window.lpLastIssues = arr;
}
// expose to pill controller
window.renderIssueList = renderIssueList;


  function apply(text){
    const draft = $("draft");
    const view = $("draftView");
    if(!draft || !view) return;

    const sents = sentenceSplit(text);
    // Persist sentence split for replacement + regression-friendly demos
    window.lpEssayState = window.lpEssayState || {};
    const state = window.lpEssayState;
    state.sents = sents.slice();
    state.replacements = state.replacements || {};
    let issues = [];
    sents.forEach((s,i)=> issues = issues.concat(score(s,i)));
    issues.sort((a,b)=> (b.sev-a.sev) || (a.sidx-b.sidx));
    // If a sentence has been replaced, treat it as resolved for this demo run
    // (removes its highlight and reduces the issue count/score penalty)
    issues = issues.filter(it => !Object.prototype.hasOwnProperty.call(state.replacements, it.sidx));

    const chosenAll = issues.slice(0, MAX).map(it=>{
      const sent = sents[it.sidx] || "";
      return {
        ...it,
        sent,
        rewrite: generateRewrite(sent, it.type)
      };
    });
    // keep state for Replace Sentence
    window.lpEssayState = window.lpEssayState || {};
    window.lpEssayState.sents = sents.slice();
    // pick one issue per sentence (highest severity)
    const bySent = new Map();
    chosenAll.forEach(it=>{
      const cur = bySent.get(it.sidx);
      if(!cur || it.sev > cur.sev) bySent.set(it.sidx, it);
    });

    // Build highlighted HTML
    let out = "";
    sents.forEach((s,i)=>{
      const it = bySent.get(i);
      if(it){
        const rw = generateRewrite(s, it.type);
        out += `<mark data-issue="${esc(it.type)}" data-sidx="${i}" class="${it.cls} ${it.sev>=3? "sev-warn" : (it.sev===2? "sev-amber" : "sev-minor")}">${esc(s)}
          <span class="rewriteTip">
            <div class="tipTitle">LP Suggested Rewrite</div>
            <div class="tipBody">${esc(rw)}</div>
            <button class="copyBtn" data-copy-inline="${i}" data-sidx="${i}" data-type="${esc(it.type)}" data-sentence="${esc(s)}">Copy suggestion</button>
          </span>
        </mark> `;
      } else {
        out += esc(s) + " ";
      }
    });

    view.innerHTML = out.trim();
    view.classList.remove("hidden");
    draft.classList.add("hidden");

    // wire inline copy
    view.querySelectorAll("[data-copy-inline]").forEach(btn=>{
      btn.textContent = "Replace sentence";
      btn.addEventListener("click", async (e)=>{
        e.preventDefault(); e.stopPropagation();
        try{
          const mark = btn.closest("mark");
          const sidx = Number(btn.getAttribute("data-sidx") ?? (mark ? mark.getAttribute("data-sidx") : NaN));
          const type = btn.getAttribute("data-type") || (mark ? mark.getAttribute("data-issue") : null) || "Wording";
          const raw = btn.getAttribute("data-sentence") || (mark ? mark.textContent : "") || "";
          const rewrite = generateRewrite(raw, type);
          lpReplaceSentenceAtIndex(sidx, rewrite);
          lpToast("Sentence replaced ✅");
        }catch(err){
          console.error(err);
          lpToast("Could not replace sentence");
        }
      });
    });

    // Update coaching text
    const fb = $("feedbackText");
    if(fb){
      fb.innerHTML = `Found <b>${Math.min(MAX, chosenAll.length)}</b> priority improvements. Use the Issue Map to jump to exact lines.`;
    }
    const ot = $("outlineText");
    if(ot){
      ot.innerHTML = `Suggested flow: <b>Hook → Context → Challenge → Action → Result → Reflection</b>. Make each section specific with concrete moments and outcomes.`;
    }

    // Update score (simple)
    const scoreVal = $("scoreVal");
    const fill = $("coachBarFill");
    if(scoreVal){
      const base = 90;
      const penalty = Math.min(50, chosenAll.length * 2);
      const score = Math.max(35, base - penalty);
      scoreVal.textContent = String(score);
      if(fill) fill.style.width = score + "%";
    }

    // Build right pane issue list
    window.lpAllIssues = chosenAll;
    renderIssueList(chosenAll);
    // Show + count issue filter pills (under tabs)
    if(typeof window.updateIssuePills === "function"){ try{ window.updateIssuePills(chosenAll); }catch(e){} }

    // Expose latest Issue Map items for Coach Engine
    window.lpLastIssues = chosenAll;
    if(typeof window.lpCoachSyncFromIssues === "function"){
      try{ window.lpCoachSyncFromIssues(chosenAll); }catch(e){}
    }
}

  function runStep1(){
    const draft = $("draft");
    if(!draft) return;
    const text = (draft.value||"").trim();
    const words = text.split(/\s+/).filter(Boolean).length;
    if(words < 20){
      alert("Paste a longer essay (20+ words) to run Strategy Review.");
      return;
    }
    apply(text);
    // Visual workflow: advance highlight to Step 2 after Step 1 completes
    try{
      const b1 = $("btnStep1");
      const b2 = $("btnStep2");
      if(b1){ b1.classList.remove("primary"); b1.classList.add("ghost"); }
      if(b2){ b2.classList.remove("ghost"); b2.classList.add("primary"); }
    }catch(e){}
  }

  // Wire Step 1 button
  const btn = $("btnStep1");
  if(btn){
    btn.addEventListener("click", (e)=>{ e.preventDefault(); runStep1(); });
  }

  // Keep Before/After toggle working
  const ba = $("btnBeforeAfter");
  if(ba){
    ba.addEventListener("click", (e)=>{
      e.preventDefault();
      const draft = $("draft");
      const view = $("draftView");
      if(!draft || !view) return;
      const showing = !view.classList.contains("hidden");
      if(showing){
        view.classList.add("hidden");
        draft.classList.remove("hidden");
      } else {
        // If view is empty, run Step 1; else show view
        if(!view.innerHTML.trim()) runStep1();
        else { draft.classList.add("hidden"); view.classList.remove("hidden"); }
      }
    });
  }
})();
</script>
<script>
/* ===== Step 2 modal-first + Apply fixes from Issue Map (stable override) ===== */
(function(){
  const $ = (id)=>document.getElementById(id);
  let beforeText = "";
  let afterText = "";
        if(window.lpEssayState){ window.lpEssayState.afterPolish = afterText; }
  let lastIssues = [];   // store issues with sentence index + rewrite

  function getDraftText(){
    const ta = $("draft");
    return (ta?.value || "").trim();
  }
  function setDraftText(t){
    const ta = $("draft");
    if(ta) ta.value = t;
  }

  
function polish(text){
  // deterministic demo polish (keeps paragraphs + spacing)
  let raw = (text||"").replace(/\r\n/g,"\n").trim();

  // split into paragraphs (preserve intentional blank lines)
  let paras = raw.split(/\n\s*\n+/).map(p=>p.replace(/\s+/g," ").trim()).filter(Boolean);

  paras = paras.map(p=>{
    let t = p;

    // light filler removal (demo-safe)
    t = t.replace(/\bvery\b|\breally\b|\bjust\b|\bbasically\b|\bliterally\b|\bactually\b/gi, "");
    t = t.replace(/\s{2,}/g, " ").trim();
    t = t.replace(/\bi think\b/gi, "I believe");
    t = t.replace(/\bthings\b/gi, "factors");

    // basic sentence capitalization within the paragraph
    t = t.split(/(?<=[\.\!\?])\s+/).map(s=>{
      s = s.trim();
      if(!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }).join(" ");

    return t.trim();
  });

  return paras.join("\n\n");
}


function autoParagraphize(t){
  const txt = (t||"").replace(/\r\n/g,"\n").trim();
  if(!txt) return txt;
  if(/\n\s*\n/.test(txt)) return txt; // already has paragraphs
  const sents = txt.split(/(?<=[\.\!\?])\s+/).map(s=>s.trim()).filter(Boolean);

  // group sentences into paragraphs (3 sentences each) for clean readability
  const groups = [];
  for(let i=0;i<sents.length;i+=3){
    groups.push(sents.slice(i,i+3).join(" "));
  }
  return groups.join("\n\n");
}



  function sentenceSplit(text){
    return text.replace(/\s+/g,' ')
      .split(/(?<=[\.\!\?])\s+(?=[A-Z0-9“"'])/)
      .map(s=>s.trim()).filter(Boolean);
  }

  
function splitSents(t){
  return (t||"").trim().split(/(?<=[\.\!\?])\s+/).map(s=>s.trim()).filter(Boolean);
}

function escapeHTML(s){
  return String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function renderParagraphsHTML(text){
  const t = (text||"").replace(/\r\n/g,"\n").trim();
  if(!t) return "";
  const paras = t.split(/\n\s*\n+/).map(p=>p.trim()).filter(Boolean);
  return paras.map(p=>`<p style="margin:0 0 12px 0;">${escapeHTML(p).replace(/\n/g,"<br>")}</p>`).join("") || "";
}
function countSyllables(word){
  const w = String(word||"").toLowerCase().replace(/[^a-z]/g,"");
  if(!w) return 0;
  // naive vowel-group syllable count
  const groups = w.match(/[aeiouy]+/g);
  let n = groups ? groups.length : 0;
  // silent trailing 'e'
  if(w.endsWith("e") && n>1) n--;
  return Math.max(1, n);
}
function fleschKincaidGrade(text){
  const t = (text||"").trim();
  if(!t) return null;
  const words = t.split(/\s+/).filter(Boolean);
  const sents = splitSents(t);
  const wordCount = words.length || 1;
  const sentCount = Math.max(1, sents.length);
  let syll = 0;
  for(const w of words){ syll += countSyllables(w); }
  // FK Grade = 0.39*(words/sents) + 11.8*(syll/words) - 15.59
  const grade = 0.39*(wordCount/sentCount) + 11.8*(syll/wordCount) - 15.59;
  return Math.round(grade*10)/10;
}
function countMatches(text, regex){
  const m = (text||"").match(regex);
  return m ? m.length : 0;
}
function countLongSentences(text, thresholdWords=28){
  const sents = splitSents((text||"").trim());
  let c = 0;
  for(const s of sents){
    const wc = s.split(/\s+/).filter(Boolean).length;
    if(wc >= thresholdWords) c++;
  }
  return c;
}
function summarizeChanges(before, after){
  const b = (before||"").trim();
  const a = (after||"").trim();

  const bWords = b ? b.split(/\s+/).filter(Boolean).length : 0;
  const aWords = a ? a.split(/\s+/).filter(Boolean).length : 0;

  const bParas = b ? b.split(/\n\s*\n+/).filter(p=>p.trim()).length : 0;
  const aParas = a ? a.split(/\n\s*\n+/).filter(p=>p.trim()).length : 0;

  const bS = splitSents(b);
  const aS = splitSents(a);

  // sentence-level change estimate (positionally aligned)
  const n = Math.min(bS.length, aS.length);
  let changed = 0;
  for(let i=0;i<n;i++){
    const x = bS[i].replace(/\s+/g," ").trim();
    const y = aS[i].replace(/\s+/g," ").trim();
    if(x && y && x.toLowerCase() !== y.toLowerCase()) changed++;
  }
  const added = Math.max(0, aS.length - bS.length);
  const removed = Math.max(0, bS.length - aS.length);

  const deltaWords = aWords - bWords;
  const direction = deltaWords === 0 ? "no change" : (deltaWords < 0 ? `${Math.abs(deltaWords)} fewer words` : `${deltaWords} more words`);

  // Clarity: long sentences + filler phrases
  const fillerRe = /\b(really|very|just|basically|actually|literally|kind of|sort of|in order to|a lot|maybe|somewhat)\b/gi;
  const bLong = countLongSentences(b, 28);
  const aLong = countLongSentences(a, 28);
  const bFiller = countMatches(b, fillerRe);
  const aFiller = countMatches(a, fillerRe);

  // Tone: passive voice + vague words
  const passiveRe = /\b(was|were|is|are|been|being)\b\s+\b\w+ed\b/gi;
  const vagueRe = /\b(things|stuff|good|nice|bad|great|a lot|many|some|various|interesting)\b/gi;
  const bPassive = countMatches(b, passiveRe);
  const aPassive = countMatches(a, passiveRe);
  const bVague = countMatches(b, vagueRe);
  const aVague = countMatches(a, vagueRe);

  // Readability: FK grade + concision metrics
  const bFK = fleschKincaidGrade(b);
  const aFK = fleschKincaidGrade(a);
  const bWPS = bS.length ? Math.round((bWords/bS.length)*10)/10 : null;
  const aWPS = aS.length ? Math.round((aWords/aS.length)*10)/10 : null;

  // Readiness gain: use existing score() if available
  let bScore = null, aScore = null, deltaScore = null;
  try{
    if(typeof score === "function"){
      bScore = score(b).score;
      aScore = score(a).score;
      deltaScore = aScore - bScore;
    }
  }catch(e){}

  return {
    bWords, aWords, bParas, aParas,
    bSent: bS.length, aSent: aS.length,
    changed, added, removed, direction,
    bLong, aLong, bFiller, aFiller,
    bPassive, aPassive, bVague, aVague,
    bFK, aFK, bWPS, aWPS,
    bScore, aScore, deltaScore
  };
}
function escapeHtml(s){
  return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function renderDiff(before, after){
  const b = splitSents(before);
  const a = splitSents(after);
  const out = [];
  const n = Math.max(b.length, a.length);
  for(let i=0;i<n;i++){
    const bs = b[i] || "";
    const as = a[i] || "";
    if(!as) continue;
    if(bs.trim() !== as.trim()){
      out.push('<span class="diffAdd">'+escapeHtml(as)+'</span>');
    } else {
      out.push(escapeHtml(as));
    }
  }
  return out.join(" ");
}

function openModal(mode){
  const m = $("baModal");
  if(!m) return;

  const grid = m.querySelector(".baGrid");
  const beforeCol = grid?.children?.[0];
  const afterCol = grid?.children?.[1];

  if(mode === "after"){
    $("baModeLabel").textContent = "Final Polish";
    $("baSubLabel").textContent = "Polished version preview (changes highlighted) — Note: blue highlights show what Final Polish modified";
    if(beforeCol) beforeCol.style.display = "none";
    if(afterCol) afterCol.style.display = "";
  } else {
    $("baModeLabel").textContent = "Before / After";
    $("baSubLabel").textContent = "Compare your draft to the polished version";
    if(beforeCol) beforeCol.style.display = "";
    if(afterCol) afterCol.style.display = "";
  }

  const beforeBox = $("baBefore");
  const afterBox = $("baAfter");
  const summaryBox = $("baSummary");

  // Always compute summary if we have both sides
  const summary = summarizeChanges(beforeText || "", afterText || "");

  if(mode === "after"){
    // Keep highlighted diff view for the Polish preview mode
    if(summaryBox){
      summaryBox.innerHTML = `<b>Polish summary</b><div class="row">
        <span class="chip">Edits: ${summary.changed + summary.added + summary.removed}</span>
        <span class="chip">Sentences: ${summary.bSent} → ${summary.aSent}</span>
        <span class="chip">Words: ${summary.bWords} → ${summary.aWords} (${summary.direction})</span>
      </div>
      <div style="margin-top:8px; opacity:.95;">
        <div>• <b>Clarity</b>: long sentences ${summary.bLong} → ${summary.aLong}, filler words ${summary.bFiller} → ${summary.aFiller}</div>
        <div>• <b>Tone</b>: passive voice ${summary.bPassive} → ${summary.aPassive}, vague words ${summary.bVague} → ${summary.aVague}</div>
        <div>• <b>Readability</b>: FK grade ${summary.bFK ?? "—"} → ${summary.aFK ?? "—"}, words/sentence ${summary.bWPS ?? "—"} → ${summary.aWPS ?? "—"}</div>
        <div>• <b>Readiness</b>: score ${summary.bScore ?? "—"} → ${summary.aScore ?? "—"}${(summary.deltaScore!=null)?` (Δ ${summary.deltaScore>=0?"+":""}${summary.deltaScore})`:""}</div>
      </div>`;
    }
    if(beforeBox) beforeBox.innerHTML = "";
    if(afterBox) afterBox.innerHTML = renderDiff(beforeText || "", afterText || "");
  } else {
    // Clean paragraph view for Before/After comparison (easy to read)
    if(summaryBox){
      summaryBox.innerHTML = `<b>What changed</b>
        <div class="row">
          <span class="chip">Sentences revised: ${summary.changed}</span>
          <span class="chip">Added: ${summary.added}</span>
          <span class="chip">Removed: ${summary.removed}</span>
          <span class="chip">Words: ${summary.bWords} → ${summary.aWords} (${summary.direction})</span>
        </div>
        <div style="margin-top:8px; opacity:.95;">
          <div>• <b>Clarity</b>: long sentences ${summary.bLong} → ${summary.aLong}, filler words ${summary.bFiller} → ${summary.aFiller}</div>
          <div>• <b>Tone</b>: passive voice ${summary.bPassive} → ${summary.aPassive}, vague words ${summary.bVague} → ${summary.aVague}</div>
          <div>• <b>Readability</b>: FK grade ${summary.bFK ?? "—"} → ${summary.aFK ?? "—"}, words/sentence ${summary.bWPS ?? "—"} → ${summary.aWPS ?? "—"}</div>
          <div>• <b>Readiness</b>: score ${summary.bScore ?? "—"} → ${summary.aScore ?? "—"}${(summary.deltaScore!=null)?` (Δ ${summary.deltaScore>=0?"+":""}${summary.deltaScore})`:""}</div>
        </div>`;
    }
    if(beforeBox){ beforeBox.classList.add("baText"); beforeBox.innerHTML = renderParagraphsHTML(beforeText || ""); }
    if(afterBox){ afterBox.classList.add("baText"); afterBox.innerHTML = renderParagraphsHTML(afterText || ""); }
    if(!afterText && afterBox){
      afterBox.innerHTML = `<p style="margin:0;">Run Step 2 (Final Polish) to generate the polished version.</p>`;
    }
  }

  // Actions
  const copyBtn = $("copyAfter");
  if(copyBtn){
    copyBtn.textContent = "Copy polished text";
    copyBtn.onclick = ()=>{
      navigator.clipboard.writeText(afterText || "");
      copyBtn.textContent = "Copied ✓";
      setTimeout(()=>copyBtn.textContent="Copy polished text", 1200);
    };
  }

  const applyBtn = $("applyAfter");
  if(applyBtn){
    applyBtn.disabled = false;
    applyBtn.textContent = "Apply to draft";
    applyBtn.onclick = ()=>{
      const _scrollY = window.scrollY;

      if(afterText){
        setDraftText(afterText);
        // Ensure student sees the polished essay in the main draft box (not hidden behind highlights)
        const _draftEl = $("draft");
        const _viewEl  = $("draftView");
        if(_draftEl && _viewEl){
          _viewEl.classList.add("hidden");
          _draftEl.classList.remove("hidden");
          try{ _draftEl.focus({preventScroll:true}); }catch(e){ try{ _draftEl.focus(); }catch(e2){} }
        }
        if(typeof lpToast === "function"){ lpToast("Final polish applied to draft ✓","ok",3000); }
        // Keep the viewport anchored (don’t jump down the page)
        try{ window.scrollTo({top:_scrollY, behavior:"instant"}); }catch(e){ window.scrollTo(0,_scrollY); }

        if(typeof window.updateWordCount === "function"){ try{ window.updateWordCount(); }catch(e){} }
      }
      applyBtn.textContent = "Applied ✓";
      applyBtn.disabled = true;
      closeModal();
    };
  }

  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
}

function closeModal(){
  const m = $("baModal");
  if(!m) return;
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
}


window.closeModal = closeModal;
function runStep2(){
    const text = getDraftText();
    if(text.split(/\s+/).filter(Boolean).length < 20){
      alert("Paste a longer essay (20+ words) to run Final Polish.");
      return;
    }
    beforeText = text;
    afterText = autoParagraphize(polish(text));
    openModal("after"); // immediate popup as requested
  }

  // Wire Step2 button (force)
  const b2 = $("btnStep2");
  if(b2){
    b2.addEventListener("click", (e)=>{ e.preventDefault(); runStep2(); }, true);
  }

  // Wire top Before/After button to split mode (if Step2 ran, otherwise run Step2 then split)
  const topBA = $("btnBeforeAfter");
  if(topBA){
    topBA.addEventListener("click", (e)=>{
      e.preventDefault();
      const text = getDraftText();
      if(!afterText){
        beforeText = text;
        afterText = autoParagraphize(polish(text));
      }
      openModal("split");
    }, true);
  }

  // Wire right-pane Before/After button (if exists)
  const oba = $("openBeforeAfter2");
  if(oba){
    oba.addEventListener("click", (e)=>{
      e.preventDefault();
      const text = getDraftText();
      if(!afterText){
        beforeText = text;
        afterText = autoParagraphize(polish(text));
      }
      openModal("split");
    }, true);
  }

  // Modal buttons
  $("closeBAModal")?.addEventListener("click", closeModal);
  $("baModal")?.addEventListener("click", (e)=>{ if(e.target === $("baModal")) closeModal(); });

  $("copyAfter")?.addEventListener("click", ()=>{
    if(!afterText) return;
    navigator.clipboard.writeText(afterText);
    const b = $("copyAfter");
    b.textContent = "Copied";
    setTimeout(()=>b.textContent="Copy After", 1200);
  });

  $("replaceDraft")?.addEventListener("click", ()=>{
    if(!afterText) return;
    setDraftText(afterText);
    closeModal();
    // Show textarea again (student can keep editing)
    const dv = $("draftView");
    const ta = $("draft");
    if(dv && ta){
      dv.classList.add("hidden");
      ta.classList.remove("hidden");
    }
  });

  /* ===== Apply rewrite from Issue Map (if Issue Map exists) =====
     We attach event delegation to #issueList and support buttons with data-apply + data-copy.
  */
  function applySentenceRewrite(sidx, rewrite){
    const text = getDraftText();
    const sents = sentenceSplit(text);
    if(sidx < 0 || sidx >= sents.length) return;
    sents[sidx] = rewrite;
    const updated = sents.join(" ");
    setDraftText(updated);

    // Rerun Step1 if runSmartReview exists to refresh highlights/map
    if(typeof window.runSmartReview === "function"){
      try{ window.runSmartReview(); } catch(e){ /* ignore */ }
    }
  }

  const issueList = $("issueList");
  if(issueList){
    issueList.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const applyIdx = btn.getAttribute("data-apply");
      if(applyIdx !== null){
        const i = parseInt(applyIdx,10);
        const rw = document.getElementById("rw_"+i)?.innerText || "";
        const sidx = parseInt(btn.getAttribute("data-sidx"),10);
        if(rw && Number.isFinite(sidx)) applySentenceRewrite(sidx, rw);
      }
    });
  }

  // Patch existing Issue Map rendering: add Apply buttons if missing
  function patchIssueMapApplyButtons(){
    const list = $("issueList");
    if(!list) return;
    list.querySelectorAll(".issueItem").forEach((item, i)=>{
      const headLoc = item.querySelector(".issueLoc");
      const sMatch = headLoc?.textContent?.match(/Sentence\s+(\d+)/i);
      const sidx = sMatch ? (parseInt(sMatch[1],10)-1) : null;

      const actions = item.querySelector(".issueActions");
      if(actions && !actions.querySelector("[data-apply]")){
        const b = document.createElement("button");
        b.className = "miniBtn";
        b.type = "button";
        b.textContent = "Apply";
        if(sidx !== null){
          b.setAttribute("data-apply", String(i));
          b.setAttribute("data-sidx", String(sidx));
        }
        actions.appendChild(b);
      }
    });
  }

  // run after any Step1 execution
  const oldSmart = window.runSmartReview;
  if(typeof oldSmart === "function"){
    window.runSmartReview = function(){
      const r = oldSmart.apply(this, arguments);
      setTimeout(patchIssueMapApplyButtons, 50);
      return r;
    };
  } else {
    // if step1 not present, still patch
    setTimeout(patchIssueMapApplyButtons, 300);
  }
})();
</script>


<script>
/* ===== LaunchPath Coach Engine v1 (OFFLINE DEMO, student-safe) ===== */
(function(){
  const $ = (id)=>document.getElementById(id);

  function getText(){ return ($("draft")?.value || "").trim(); }
  function words(text){ return (text||"").trim().split(/\s+/).filter(Boolean); }
  function sentences(text){
    return (text||"").replace(/\s+/g," ").split(/(?<=[\.\!\?])\s+(?=[A-Z0-9“"'])/).map(s=>s.trim()).filter(Boolean);
  }
  function paragraphs(text){
    const ps = (text||"").split(/\n\s*\n/).map(p=>p.trim()).filter(Boolean);
    return ps.length ? ps : [text.trim()];
  }
  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  const CLICHES = ["ever since i was","since i was young","in conclusion","overall","throughout my life","at the end of the day","it taught me","i learned that"];
  const FILLERS = ["very","really","just","basically","literally","actually","kind of","sort of","a lot"];
  const VAGUE = ["good","great","nice","amazing","awesome","interesting","important","thing","things","stuff"];
  const PASSIVE = /\b(was|were|is|are|been|being)\b\s+\b\w+(ed|en)\b/i;

  function computeScore(text){
    const w = words(text).length;
    const sents = sentences(text);
    const ps = paragraphs(text);

    const hasBreaks = ps.length >= 3;
    const hasConclusion = /in conclusion|looking back|ultimately|as a result/i.test(text);
    const structureBase = 18 + (hasBreaks?4:0) + (hasConclusion?3:0) + (sents.length>=8?2:0);

    const longSents = sents.filter(s=>words(s).length>=28).length;
    const clarityBase = 22 - longSents*2;

    const passiveCount = sents.filter(s=>PASSIVE.test(s)).length;
    const voiceBase = 22 - passiveCount*2;

    const vagueCount = (text.toLowerCase().match(new RegExp("\\b(" + VAGUE.join("|") + ")\\b","g"))||[]).length;
    const numbers = (text.match(/\b\d+(\.\d+)?\b/g)||[]).length;
    const specificityBase = 18 + Math.min(5,numbers) - vagueCount;

    const structure = clamp(structureBase, 0, 25);
    const clarity = clamp(clarityBase, 0, 25);
    const voice = clamp(voiceBase, 0, 25);
    const specificity = clamp(specificityBase, 0, 25);
    const total = clamp(structure+clarity+voice+specificity, 0, 100);

    return {structure, clarity, voice, specificity, total, w, longSents, passiveCount, vagueCount};
  }

  function setBar(id, val, max){
    const el = $(id);
    if(!el) return;
    const pct = clamp((val/(max||100))*100,0,100);
    el.style.width = pct + "%";
  }

  function makePlan(score){
    const plan = [];
    const low = (k)=> score[k] < 18;

    if(low("structure")){
      plan.push({k:"Structure", t:"Clarify your story arc", d:"Add a clear hook, a specific challenge, and a reflection that connects to who you are now."});
    }
    if(score.longSents >= 2){
      plan.push({k:"Clarity", t:"Split long sentences", d:`You have ${score.longSents} long sentence(s). Break them into two and lead with the main action.`});
    }
    if(score.passiveCount >= 2){
      plan.push({k:"Voice", t:"Rewrite passive voice", d:"Convert passive phrases to active voice (who did what?) to sound more confident."});
    }
    if(score.vagueCount >= 2){
      plan.push({k:"Specificity", t:"Replace vague words", d:"Swap vague words for concrete details: what you did, what changed, and the result."});
    }
    plan.push({k:"Coach", t:"Add proof of growth", d:"For each lesson learned, add a quick example: what you did next and what changed."});
    return plan.slice(0,5);
  }

  function makeQuestions(text){
    const qs = [];
    qs.push("What is the single moment you want the reader to remember after finishing your essay?");
    qs.push("What did you do (actions) that proves your values—beyond what you say you learned?");
    qs.push("What specific obstacle did you face, and what choice did you make when it mattered?");
    if(!(text.match(/\b\d+\b/g)||[]).length){
      qs.push("Can you include one concrete detail (a number, timeframe, or measurable result) to make it more believable?");
    }
    return qs.slice(0,6);
  }

  function suggestOutline(){
    return [
      {t:"Hook (1–3 sentences)", d:"Start with a specific moment: place, action, and stakes."},
      {t:"Context", d:"Briefly explain what led to the moment (no resume-style list)."},
      {t:"Challenge", d:"Show the obstacle or tension—what made this hard or meaningful?"},
      {t:"Action + Result", d:"What did you do? What happened? Include one concrete detail."},
      {t:"Reflection", d:"What changed in your thinking/behavior? Connect it to future goals."},
      {t:"Closing (1–2 sentences)", d:"End with a forward-looking line, not a generic conclusion."}
    ];
  }

  function sentenceSuggestions(text){
    const sents = sentences(text);
    const out = [];
    sents.forEach((s,i)=>{
      if(out.length>=6) return;
      const low = s.toLowerCase();

      if(CLICHES.some(c=>low.includes(c))){
        out.push({i, type:"Voice", before:s, after:s.replace(/in conclusion,?/i,"Looking back,").replace(/overall,?/i,"Ultimately,")});
        return;
      }
      if(FILLERS.some(f=>new RegExp("\\b"+f+"\\b","i").test(s))){
        out.push({i, type:"Clarity", before:s, after:s.replace(new RegExp("\\b(" + FILLERS.join("|") + ")\\b","gi"),"").replace(/\s{2,}/g," ").trim()});
        return;
      }
      if(VAGUE.some(v=>new RegExp("\\b"+v+"\\b","i").test(s))){
        out.push({i, type:"Specificity", before:s, after:s.replace(/\b(things|stuff)\b/gi,"specific outcomes").replace(/\b(good|great|nice|amazing|awesome)\b/gi,"strong")});
        return;
      }
      if(words(s).length>=30){
        const parts = s.split(/,\s+| and /);
        const after = parts.length>=2 ? (parts[0].trim()+". "+parts.slice(1).join(" ").trim()) : s;
        out.push({i, type:"Clarity", before:s, after});
        return;
      }
      if(PASSIVE.test(s)){
        out.push({i, type:"Voice", before:s, after:s.replace(/\bwas\b|\bwere\b|\bbeen\b|\bbeing\b/gi,"").replace(/\s{2,}/g," ").trim()});
        return;
      }
    });
    return out;
  }

  function renderCoach(text){
    const score = computeScore(text);

    // overall
    const scoreVal = $("scoreVal");
    const fill = $("coachBarFill");
    if(scoreVal) scoreVal.textContent = String(score.total);
    if(fill) fill.style.width = score.total + "%";

    // scorecard
    $("scStructureVal").textContent = score.structure;
    $("scClarityVal").textContent = score.clarity;
    $("scVoiceVal").textContent = score.voice;
    $("scSpecificityVal").textContent = score.specificity;
    setBar("scStructure", score.structure, 25);
    setBar("scClarity", score.clarity, 25);
    setBar("scVoice", score.voice, 25);
    setBar("scSpecificity", score.specificity, 25);

    const oneLine = $("coachOneLine");
    if(oneLine) oneLine.innerHTML = `Readiness <b>${score.total}/100</b> (target 80+). Word count: <b>${score.w}</b>.`;

    // plan
    const planRoot = $("coachPlan");
    if(planRoot){
      planRoot.innerHTML = "";
      makePlan(score).forEach((p,idx)=>{
        const div = document.createElement("div");
        div.className = "coachItem";
        div.innerHTML = `<div class="k">${idx+1}. ${p.k}</div><div class="t">${p.t}</div><div class="d">${p.d}</div>`;
        planRoot.appendChild(div);
      });
    }

    // questions
    const qRoot = $("coachQuestions");
    if(qRoot){
      qRoot.innerHTML = "";
      makeQuestions(text).forEach((q)=>{
        const div = document.createElement("div");
        div.className = "coachItem";
        div.innerHTML = `<div class="k">Question</div><div class="t">${q}</div>`;
        qRoot.appendChild(div);
      });
    }

    // outline
    const oRoot = $("coachOutline");
    if(oRoot){
      oRoot.innerHTML = "";
      suggestOutline().forEach((o)=>{
        const div = document.createElement("div");
        div.className = "coachItem";
        div.innerHTML = `<div class="k">Outline</div><div class="t">${o.t}</div><div class="d">${o.d}</div>`;
        oRoot.appendChild(div);
      });
    }

    // sentence suggestions
    const sRoot = $("coachSentenceList");
    if(sRoot){
      sRoot.innerHTML = "";
      const sugg = sentenceSuggestions(text);
      if(!sugg.length){
        const div = document.createElement("div");
        div.style.color = "rgba(255,255,255,.62)";
        div.textContent = "No sentence suggestions detected. Nice work — run Step 1 again after edits.";
        sRoot.appendChild(div);
      } else {
        sugg.forEach((s)=>{
          const card = document.createElement("div");
          card.className = "suggCard";
          card.dataset.after = s.after;
          card.dataset.idx = String(s.i);
          card.innerHTML = `
            <div class="meta">${s.type} • Sentence ${s.i+1}</div>
            <div class="before"><b>Before:</b> ${escapeHtml(s.before)}</div>
            <div class="after"><b>Suggestion:</b> ${escapeHtml(s.after)}</div>
            <div class="actions">
              <button type="button" class="miniBtn primary" data-apply-sent="1">Apply sentence</button>
              <button type="button" class="miniBtn" data-copy-sent="1">Copy suggestion</button>
            </div>`;
          sRoot.appendChild(card);
        });
      }
    }
  }

  // Apply/copy handlers (event delegation)
  document.addEventListener("click",(e)=>{
    const jumpBtn = e.target.closest("[data-jump-sidx]");
    const copyBtn = e.target.closest("[data-copy-rewrite]");
    const applyBtn = e.target.closest("[data-apply-rewrite]");

    if(jumpBtn){
      const sidx = parseInt(jumpBtn.getAttribute("data-jump-sidx"),10);
      const mark = document.querySelector(`mark[data-sidx="${sidx}"]`);
      if(mark){
        mark.scrollIntoView({behavior:"smooth", block:"center"});
        mark.classList.add("flash");
        setTimeout(()=>mark.classList.remove("flash"), 800);
      }
      return;
    }

    if(copyBtn){
      const card = e.target.closest(".suggCard");
      const txt = card?.dataset?.rewrite || "";
      navigator.clipboard.writeText(txt);
      copyBtn.textContent = "Copied ✓";
      setTimeout(()=>copyBtn.textContent="Copy suggestion", 1200);
      return;
    }

    if(applyBtn){
      const card = e.target.closest(".suggCard");
      const sidx = parseInt(card?.dataset?.sidx||"-1",10);
      const rw = card?.dataset?.rewrite || "";
      if(Number.isFinite(sidx) && sidx>=0 && rw && typeof window.lpReplaceSentenceAtIndex === "function"){
        window.lpReplaceSentenceAtIndex(sidx, rw);
      } else if(Number.isFinite(sidx) && sidx>=0 && rw){
        // fallback: direct textarea rewrite
        const ta = $("draft");
        if(ta){
          const sents = sentences(getText());
          if(sidx < sents.length){ sents[sidx] = rw; ta.value = sents.join(" "); }
        }
      }
      if(typeof window.updateWordCount === "function"){ try{ window.updateWordCount(); }catch(e){} }
      applyBtn.textContent = "Applied ✓";
      applyBtn.disabled = true;
      return;
    }
  });

  // Run on Step 1 click (capture) + live typing
  const step1 = $("btnStep1");
  if(step1){
    step1.addEventListener("click", ()=>{
      const text = getText();
      if(words(text).length < 20) return;
      renderCoach(text);
    }, true);
  }

  const ta = $("draft");
  if(ta){
    let tmr = null;
    ta.addEventListener("input", ()=>{
      if(tmr) clearTimeout(tmr);
      tmr = setTimeout(()=>{
        const text = getText();
        if(words(text).length >= 20) renderCoach(text);
      }, 250);
    });
  }

  // ----- Sync Sentence Suggestions from Issue Map (Amber/Warning) -----
  function severityLabel(sev){
    if(sev>=3) return "Warning";
    if(sev===2) return "Amber";
    return "Minor";
  }
  function severityClass(sev){
    if(sev>=3) return "w";
    if(sev===2) return "c";
    return "p";
  }

  window.lpCoachSyncFromIssues = function(items){
    const sRoot = document.getElementById("coachSentenceList");
    if(!sRoot) return;

    const list = (items||[]).filter(it => (it.sev||0) >= 2)
      .slice()
      .sort((a,b)=> (b.sev||0)-(a.sev||0) || (a.sidx||0)-(b.sidx||0))
      .slice(0, 8);

    sRoot.innerHTML = "";
    if(!list.length){
      const div = document.createElement("div");
      div.style.color = "rgba(255,255,255,.62)";
      div.textContent = "No Amber/Warning sentences detected. Nice work — run Step 1 again after edits.";
      sRoot.appendChild(div);
      return;
    }

    list.forEach((it)=>{
      const sev = it.sev||0;
      const card = document.createElement("div");
      card.className = "suggCard";
      card.dataset.sidx = String(it.sidx ?? -1);
      card.dataset.rewrite = it.rewrite || "";
      card.innerHTML = `
        <div class="meta">${severityLabel(sev)} • ${escapeHtml(it.type||"Fix")} • Sentence ${(it.sidx??0)+1}</div>
        <div class="before"><b>Issue:</b> ${escapeHtml(it.why||"")}</div>
        <div class="after"><b>Suggestion:</b> ${escapeHtml((it.rewrite||it.sent||"").trim())}</div>
        <div class="actions">
          <button type="button" class="miniBtn primary" data-jump-sidx="${it.sidx}">Jump to sentence</button>
          <button type="button" class="miniBtn" data-copy-rewrite="${it.sidx}">Copy suggestion</button>
          <button type="button" class="miniBtn" data-apply-rewrite="${it.sidx}">Apply suggestion</button>
        </div>
      `;
      sRoot.appendChild(card);
    });
  };

})();
</script>

<!-- sentModal inserted -->

<script>
/* ===== Tabs + Issue-to-Sentence Coach (v5) ===== */
(function(){
  const panel = document.querySelector('section[aria-label="LP Coaching Panel"]');
  const tabs = document.getElementById("coachTabs");
  if(!panel || !tabs) return;

  function setTab(key){
    tabs.querySelectorAll(".coachTab").forEach(b=>{
      b.classList.toggle("active", b.dataset.tab === key);
    });
    panel.querySelectorAll(".coachBlock").forEach(el=>{
      const t = el.getAttribute("data-tab") || "overview";
      el.style.display = (t === key) ? "" : "none";
    });
  }
  
  window.lpSetCoachTab = setTab;
  setTab("overview");

  // Expose + control Issue Pills (appear after Step 1)
  window.updateIssuePills = function(items){
    const pills = document.getElementById("issuePills");
    if(!pills) return;
    const all = Array.isArray(items)? items : [];
    const warn = all.filter(x => (x.sev||0) >= 3);
    const amber = all.filter(x => (x.sev||0) === 2);
    const minor = all.filter(x => (x.sev||0) === 1);

    document.getElementById("pillAll").textContent = String(all.length);
    document.getElementById("pillWarn").textContent = String(warn.length);
    document.getElementById("pillAmber").textContent = String(amber.length);
    document.getElementById("pillMinor").textContent = String(minor.length);

    // show pills only after Step 1 has produced issues
    pills.classList.remove("hidden");

    // default filter = all
    setPillActive("all");
  };

  function setPillActive(key){
    const pills = document.getElementById("issuePills");
    if(!pills) return;
    pills.querySelectorAll(".pill").forEach(b=>{
      b.classList.toggle("active", b.dataset.filter === key);
    });
    // If user is on Issues tab, re-render list
    const all = Array.isArray(window.lpAllIssues) ? window.lpAllIssues : [];
    let filtered = all;
    if(key==="warn") filtered = all.filter(x => (x.sev||0) >= 3);
    if(key==="amber") filtered = all.filter(x => (x.sev||0) === 2);
    if(key==="minor") filtered = all.filter(x => (x.sev||0) === 1);

    // Only affects Issues list (and counts remain from full list)
    if(document.querySelector('.coachTab.active')?.dataset?.tab === "issues"){
      if(typeof window.renderIssueList === "function"){
        try{ window.renderIssueList(filtered); }catch(e){}
      }
    }
    // Keep last list for sentence clicks
    window.lpLastIssues = filtered;
  }

  document.addEventListener("click",(e)=>{
    const pill = e.target.closest("#issuePills .pill");
    if(!pill) return;
    setPillActive(pill.dataset.filter || "all");
  });

tabs.addEventListener("click",(e)=>{
    const btn = e.target.closest(".coachTab");
    if(!btn) return;
    setTab(btn.dataset.tab);
  });

  function openSentenceCoach(issue){
    const m = document.getElementById("sentModal");
    if(!m) return;

    const sidx = Number.isFinite(issue.sidx) ? issue.sidx : -1;
    const sev = issue.sev || 0;
    const type = issue.type || "Fix";
    const why = issue.why || "";
    const before = issue.sent || "";
    const after = issue.rewrite || "";

    const meta = document.getElementById("sentMeta");
    const b = document.getElementById("sentBefore");
    const a = document.getElementById("sentAfter");

    if(meta) meta.textContent = `${sev>=3 ? "Warning" : "Amber"} • ${type} • Sentence ${sidx+1}${why ? " • " + why : ""}`;
    if(b) b.textContent = before;
    if(a) a.textContent = after || "(No suggestion text provided.)";

    const copyBtn = document.getElementById("copySentAfter");
    const applyBtn = document.getElementById("applySentAfter");
    const jumpBtn = document.getElementById("jumpSent");

    if(copyBtn){
      copyBtn.textContent = "Copy suggestion";
      copyBtn.onclick = ()=>{
        navigator.clipboard.writeText(after||"");
        copyBtn.textContent="Copied ✓";
        setTimeout(()=>copyBtn.textContent="Copy suggestion",1200);
      };
    }
    if(applyBtn){
      applyBtn.disabled = false;
      applyBtn.textContent = "Apply to draft";
      applyBtn.onclick = ()=>{
        if(after && typeof window.lpReplaceSentenceAtIndex === "function"){
          window.lpReplaceSentenceAtIndex(sidx, after);
        }
        applyBtn.textContent="Applied ✓";
        applyBtn.disabled=true;
      };
    }
    if(jumpBtn){
      jumpBtn.onclick = ()=>{
        const mark = document.querySelector(`mark[data-sidx="${sidx}"]`);
        if(mark){
          mark.scrollIntoView({behavior:"smooth", block:"center"});
          mark.classList.add("flash");
          setTimeout(()=>mark.classList.remove("flash"), 800);
        }
      };
    }

    setTab("sentences");
    m.classList.add("show");
    m.setAttribute("aria-hidden","false");
  }

  function closeSentenceCoach(){
    const m = document.getElementById("sentModal");
    if(!m) return;
    m.classList.remove("show");
    m.setAttribute("aria-hidden","true");
  }
  document.getElementById("closeSentModal")?.addEventListener("click", closeSentenceCoach);
  document.getElementById("sentModal")?.addEventListener("click",(e)=>{ if(e.target === document.getElementById("sentModal")) closeSentenceCoach(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeSentenceCoach(); });

  document.addEventListener("click",(e)=>{
    const card = e.target.closest(".issueCard");
    if(!card) return;

    const txt = card.textContent || "";
    const m = txt.match(/Sentence\s+(\d+)/i);
    const sidx = m ? (parseInt(m[1],10)-1) : -1;

    const items = Array.isArray(window.lpAllIssues) ? window.lpAllIssues : (Array.isArray(window.lpLastIssues) ? window.lpLastIssues : []);
    const issue = items.find(it => it.sidx === sidx) || null;
    if(!issue) return;
    if((issue.sev||0) < 2) return;

    openSentenceCoach(issue);
  });
})();
</script>


<script>
/* ===== Word Count (robust) ===== */
(function(){
  if(typeof window.updateWordCount === "function") return;
  const $ = (id)=>document.getElementById(id);
  function countWords(s){
    return (s||"").trim().split(/\s+/).filter(Boolean).length;
  }
  window.updateWordCount = function(){
    const ta = $("draft");
    const out = $("wordCount");
    if(!ta || !out) return;
    out.textContent = String(countWords(ta.value));
  };
  const ta = $("draft");
  if(ta){
    ta.addEventListener("input", ()=>window.updateWordCount());
  }
  window.updateWordCount();
})();
</script>


<script>
/* ===== Pill Filters: force Issues tab + render filtered list (v15) ===== */
(function(){
  const pills = document.getElementById("issuePills");
  if(!pills) return;

  function setActive(btn){
    pills.querySelectorAll(".pill").forEach(b=>b.classList.toggle("active", b===btn));
  }

  function filterItems(key){
    const all = Array.isArray(window.lpAllIssues) ? window.lpAllIssues : (Array.isArray(window.lpLastIssues) ? window.lpLastIssues : []);
    if(key==="warn") return all.filter(x => (x.sev||0) >= 3);
    if(key==="amber") return all.filter(x => (x.sev||0) === 2);
    if(key==="minor") return all.filter(x => (x.sev||0) === 1);
    return all;
  }

  pills.addEventListener("click", (e)=>{
    const btn = e.target.closest(".pill");
    if(!btn) return;

    const key = btn.dataset.filter || "all";
    setActive(btn);

    try{ if(typeof window.lpSetCoachTab === "function") window.lpSetCoachTab("issues"); }catch(err){}

    const filtered = filterItems(key);
    window.lpLastIssues = filtered;

    try{ if(typeof window.renderIssueList === "function") window.renderIssueList(filtered); }catch(err){}

    const issueMap = document.querySelector('[aria-label="LP Issue Map (Top Fixes)"], [aria-label="LP Issue Map"]');
    if(issueMap){
      try{ issueMap.scrollIntoView({behavior:"smooth", block:"start"}); }catch(err){}
    }
  });
})();
</script>


<div class="baModal" id="baModal" aria-hidden="true">
  <div class="baCard" role="dialog" aria-modal="true" aria-label="Final Polish preview">
    <div class="baTop">
      <div>
        <div class="baTitle" id="baModeLabel">Final Polish</div>
        <div class="baSub" id="baSubLabel">Polished version preview</div>
          <div id="baSummary" class="baSummary"></div>
      </div>
      <button class="miniBtn" id="closeBAModal" type="button">Close</button>
    </div>

    <div class="baGrid">
      <div>
        <div class="baLabel">Before</div>
        <div class="baBox" id="baBefore"></div>
      </div>
      <div>
        <div class="baLabel">After (Final Polish)</div>
        <div class="baBox" id="baAfter"></div>
      </div>
    </div>

    <div class="baActions">
      <button class="miniBtn" id="copyAfter" type="button">Copy polished text</button>
      <button class="miniBtn primary" id="applyAfter" type="button">Apply to draft</button>
    </div>
  </div>
</div>


<script>
/* ===== Step 2 Modal Close Fix (v19) ===== */
(function(){
  function hardClose(){
    const modal = document.getElementById("baModal");
    if(!modal) return;
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
  }
  function safeClose(){
    try{
      if(typeof closeModal === "function") closeModal();
      else hardClose();
    }catch(e){ hardClose(); }
  }
  function wire(){
    const modal = document.getElementById("baModal");
    const closeBtn = document.getElementById("closeBAModal");
    if(!modal || !closeBtn) return;

    closeBtn.addEventListener("click", safeClose);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) safeClose(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") safeClose(); });
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", wire);
  else wire();
})();

/* === Submission Ready indicator (only appears after Apply to Draft AND criteria pass) === */
function lpGetNumberFromText(t){
  const m = String(t||"").match(/-?\d+(\.\d+)?/);
  return m ? Number(m[0]) : NaN;
}
function lpGetBadgeEl(){ return document.getElementById("submissionReadyPill"); }

function lpGetWarningsCount(){
  // Try state first if available
  try{
    if (window.lpState && typeof window.lpState.warningCount === "number") return window.lpState.warningCount;
    if (window.lpState && Array.isArray(window.lpState.issues)){
      return window.lpState.issues.filter(x => String(x.severity||"").toLowerCase()==="warning").length;
    }
  }catch(e){}
  // Fallback: parse warnings pill text "Warnings ( X )"
  const pills = Array.from(document.querySelectorAll("button, .pill, .tag, .issuePill"));
  for (const el of pills){
    const txt = (el.textContent||"").trim();
    if (/^Warnings\s*\(/i.test(txt)){
      const n = lpGetNumberFromText(txt);
      if (!Number.isNaN(n)) return n;
    }
  }
  return 0;
}

function lpGetScore(){
  // Look for "NN/100" in coaching panel
  const el = document.querySelector(".lpScore, .scoreValue, [data-score], .coachingScore");
  if (el && el.dataset && el.dataset.score) return Number(el.dataset.score);
  const txt = (document.body.textContent||"").match(/\b(\d{1,3})\s*\/\s*100\b/);
  return txt ? Number(txt[1]) : NaN;
}

function lpGetBaselineScore(){
  try{
    if (window.lpState && typeof window.lpState.baselineScore === "number") return window.lpState.baselineScore;
    if (typeof window.__baselineScore === "number") return window.__baselineScore;
  }catch(e){}
  return NaN;
}

function lpGetConcisionOk(){
  // If no metrics exist, don't block.
  try{
    if (window.lpState && typeof window.lpState.concisionOk === "boolean") return window.lpState.concisionOk;
  }catch(e){}
  return true;
}

function lpHasPolishOutput(){
  try{
    if (window.lpState && typeof window.lpState.afterPolish === "string" && window.lpState.afterPolish.trim().length>0) return true;
    if (typeof window.__afterPolishText === "string" && window.__afterPolishText.trim().length>0) return true;
  }catch(e){}
  // Fallback: see if After column has content (Before/After view stores it)
  const afterBox = document.querySelector("#afterEssay, #afterText, .afterEssay, .afterColumn textarea, .afterColumn pre");
  if (afterBox){
    const t = (afterBox.value || afterBox.textContent || "").trim();
    if (t.length>0) return true;
  }
  return false;
}

function lpShowSubmissionReadyIfPassed(){
  const pill = lpGetBadgeEl();
  if (!pill) return;

  // Must be after apply-to-draft
  if (!(window.lpState && window.lpState.appliedToDraft === true) && window.__appliedToDraft !== true){
    pill.classList.add("hidden");
    return;
  }

  const hasPolish = lpHasPolishOutput();
  const warnings = lpGetWarningsCount();
  const baseline = lpGetBaselineScore();
  const nowScore = lpGetScore();
  const deltaOk = (!Number.isNaN(baseline) && !Number.isNaN(nowScore)) ? ((nowScore - baseline) >= 2) : true;
  const concisionOk = lpGetConcisionOk();

  const passed = hasPolish && warnings === 0 && deltaOk && concisionOk;

  if (passed){
    pill.classList.remove("hidden");
  }else{
    pill.classList.add("hidden");
  }
}


const LP_SAMPLE_ESSAYS = [{"title": "Turning Last Place into Progress", "meta": "Perseverance · sports · growth mindset", "text": "I used to think progress had to be visible to count. On my first cross‑country race, it was visible in the worst way: I finished last.\n\nThe next week, I wrote a simple goal on my hand—“finish stronger.” It wasn’t a time goal; it was a promise to keep moving when it hurt. Over the season I learned improvement is quiet: one more hill, one better breath, one choice to return after a bad day.\n\nBy the end, I wasn’t the fastest, but I became the most consistent. I led warm‑ups for new runners and built a simple tracker so our team could see patterns in effort and recovery. When a freshman wanted to quit, I ran beside him and counted breaths until the mile was over.\n\nThat mindset followed me into school: break big problems into repeats, revise drafts instead of abandoning them, and measure progress by the work I’m willing to do. I’m applying to college with the same approach—show up, learn, and finish stronger than I started."}, {"title": "The Pantry Receipt", "meta": "Community · responsibility · reflection", "text": "At the food pantry, I learned to read stories in small details—like receipts. Each donation came with an invisible timeline: a family budgeting carefully, a student grabbing something quick, a neighbor helping quietly.\n\nMy first day, I sorted cans by label and slowed the line. An older volunteer corrected me: “People don’t eat brands. They eat dinners.” So we reorganized by meal—soups together, breakfast together—so families could leave with options, not confusion.\n\nI began translating for Arabic‑speaking visitors and tracking which items ran out fastest so we could adjust requests. I also learned that help isn’t always a speech; sometimes it’s moving quickly, making eye contact, and letting someone feel seen.\n\nServing weekly taught me leadership is practical: notice what’s missing, improve the system, and do it without needing credit. That’s the community I want in college."}, {"title": "Two Languages, One Voice", "meta": "Identity · communication · adaptation", "text": "At home I speak Arabic with my grandparents and English with my little brother. Switching languages became so normal that I didn’t notice I was also switching confidence.\n\nIn middle school I rehearsed answers in my head and replaced them with silence, afraid my words would land wrong. Debate changed that. My coach made us rewrite arguments in simpler language until the logic became clear. For the first time, I felt clarity could be learned.\n\nI practiced everywhere—explaining homework to my brother, translating announcements for my grandparents, asking teachers questions even when my voice shook. I realized confidence isn’t the absence of mistakes; it’s the willingness to be understood.\n\nNow I see bilingual life as training: listen for meaning, adjust to audiences, and connect people who are speaking past each other. In college, I want to keep building that bridge."}, {"title": "A Repair, Not a Replacement", "meta": "Problem‑solving · initiative · engineering mindset", "text": "When our family laptop stopped charging, my first instinct was to replace it. My second was to ask why a simple port could decide whether a whole device was useful.\n\nWith a borrowed toolkit and a tutorial, I opened the case expecting dramatic damage. The problem was small: a loose connector and dust packed into the port. A careful cleaning and reseat brought it back.\n\nThat repair reshaped how I work. Big failures are often collections of small ignored issues. In robotics, we stopped changing everything at once and started testing incrementally, documenting runs, and isolating variables.\n\nBy competition season, we became the team that fixed problems quickly—not because we were smarter, but because we were systematic. That’s the mindset I want to bring to college labs and teams."}, {"title": "The Quiet Confidence of Teaching", "meta": "Mentoring · growth · impact", "text": "The first time I tutored algebra, I arrived with a perfect plan and left with a messy one. My student didn’t need more examples; she needed proof she could understand.\n\nWe started by finding one part she recognized—then built from there. Each session focused on a small win: rewriting problems in her own words, checking work like a detective, and celebrating progress before moving on.\n\nOver time her questions changed from “What do I do?” to “Does this make sense?” That shift mattered more than any single grade.\n\nTutoring taught me communication is a skill, not a personality trait. When I struggle now, I look for the first part I recognize—and begin from there. In college, I want to keep building communities where learning feels possible."}];

(function(){
  const $ = (id)=>document.getElementById(id);
  const link = $("viewSamples");
  const panel = $("samplesPanel");
  const tiles = $("samplesTiles");
  const title = $("samplesPreviewTitle");
  const meta = $("samplesPreviewMeta");
  const text = $("samplesPreviewText");
  const closeBtn = $("samplesCloseBtn");
  const copyBtn = $("samplesCopyBtn");
  if(!link || !panel || !tiles || !title || !meta || !text) return;

  let selectedIdx = -1;

  function renderTiles(){
    tiles.innerHTML = "";
    LP_SAMPLE_ESSAYS.forEach((s, i)=>{
      const tile = document.createElement("div");
      tile.className = "sampleTile";
      tile.innerHTML = '<div class="sampleTileTitle"></div><div class="sampleTileSub"></div>';
      tile.querySelector(".sampleTileTitle").textContent = s.title;
      tile.querySelector(".sampleTileSub").textContent = s.meta;
      tile.addEventListener("click", ()=>select(i));
      tiles.appendChild(tile);
    });
  }

  function select(i){
    const s = LP_SAMPLE_ESSAYS[i];
    if(!s) return;
    selectedIdx = i;
    Array.from(tiles.children).forEach((el, idx)=>{
      if(idx===i) el.classList.add("active"); else el.classList.remove("active");
    });
    title.textContent = s.title;
    meta.textContent = s.meta;
    text.textContent = s.text;
  }

  function openPanel(){
    panel.classList.remove("hidden");
    if(selectedIdx === -1) select(0);
    // keep page stable; no scrolling
  }
  function closePanel(){
    panel.classList.add("hidden");
  }

  link.addEventListener("click", (e)=>{ e.preventDefault(); openPanel(); });
  if(closeBtn) closeBtn.addEventListener("click", (e)=>{ e.preventDefault(); closePanel(); });

  if(copyBtn){
    copyBtn.addEventListener("click", ()=>{
      const s = LP_SAMPLE_ESSAYS[selectedIdx] || null;
      const payload = (s && s.text) ? s.text : "";
      if(!payload) return;
      const doToast = (msg)=>{ try{ if(typeof lpToast==="function") lpToast(msg,"ok",2000);}catch(e){} };
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(payload).then(()=>doToast("Copied sample ✓")).catch(()=>fallbackCopy(payload, doToast));
      }else{
        fallbackCopy(payload, doToast);
      }
    });
  }

  function fallbackCopy(payload, doToast){
    const ta = document.createElement("textarea");
    ta.value = payload;
    ta.style.position="fixed"; ta.style.left="-9999px"; ta.style.top="0";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand("copy"); doToast("Copied sample ✓"); }catch(e){}
    document.body.removeChild(ta);
  }

  renderTiles();
})();

</script>


<script>

/* ===== Submission Ready (non-invasive patch) =====
   Shows ✓ Submission Ready next to "Save to My List" ONLY after:
   - Step 1 has been run at least once
   - Step 2 "Apply to draft" has been clicked
   - Score >= 80
   This patch does NOT change existing UI/logic; it only toggles visibility of the pill.
*/
(function(){
  const pill = document.getElementById("submissionReadyPill");
  if(!pill) return;

  const S = window.__lpSubmitState = window.__lpSubmitState || { step1:false, polishApplied:false, score:0 };

  function readScore(){
    const el = document.getElementById("scoreVal");
    if(!el) return NaN;
    const n = parseFloat(String(el.textContent||"").replace(/[^\d.]/g,""));
    return Number.isFinite(n) ? n : NaN;
  }

  function update(){
    const score = readScore();
    if(Number.isFinite(score)) S.score = score;
    const ok = !!S.step1 && !!S.polishApplied && Number.isFinite(S.score) && S.score >= 80;
    pill.classList.toggle("hidden", !ok);
  }

  // Step 1 completion
  const btnStep1 = document.getElementById("btnStep1");
  if(btnStep1){
    btnStep1.addEventListener("click", ()=>{ S.step1 = true; setTimeout(update, 120); }, true);
  }

  // Apply-to-draft button in this build is #applyAfter
  const applyBtn = document.getElementById("applyAfter");
  if(applyBtn){
    applyBtn.addEventListener("click", ()=>{ S.polishApplied = true; setTimeout(update, 180); }, true);
  } else {
    // fallback: match by button text (case-insensitive)
    const btns = Array.from(document.querySelectorAll("button"));
    const b = btns.find(x => (x.textContent||"").trim().toLowerCase() === "apply to draft" || (x.textContent||"").trim().toLowerCase()==="apply to draft");
    if(b){
      b.addEventListener("click", ()=>{ S.polishApplied = true; setTimeout(update, 180); }, true);
    }
  }

  // Keep in sync as score updates
  setInterval(update, 700);
  setTimeout(update, 200);
})();
/* ===== End Submission Ready patch ===== */

</script>
</body>
</html>
